exports.__esModule = true;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _fragmentOpcodeCompiler = require('./fragment-opcode-compiler');

var _fragmentOpcodeCompiler2 = _interopRequireDefault(_fragmentOpcodeCompiler);

var _fragmentJavascriptCompiler = require('./fragment-javascript-compiler');

var _fragmentJavascriptCompiler2 = _interopRequireDefault(_fragmentJavascriptCompiler);

var _hydrationOpcodeCompiler = require('./hydration-opcode-compiler');

var _hydrationOpcodeCompiler2 = _interopRequireDefault(_hydrationOpcodeCompiler);

var _hydrationJavascriptCompiler = require('./hydration-javascript-compiler');

var _hydrationJavascriptCompiler2 = _interopRequireDefault(_hydrationJavascriptCompiler);

var _templateVisitor = require("./template-visitor");

var _templateVisitor2 = _interopRequireDefault(_templateVisitor);

var _utils = require("./utils");

var _htmlbarsUtilQuoting = require("../htmlbars-util/quoting");

var _htmlbarsUtilArrayUtils = require("../htmlbars-util/array-utils");

function TemplateCompiler(options) {
  this.options = options || {};
  this.consumerBuildMeta = this.options.buildMeta || function () {};
  this.fragmentOpcodeCompiler = new _fragmentOpcodeCompiler2.default();
  this.fragmentCompiler = new _fragmentJavascriptCompiler2.default();
  this.hydrationOpcodeCompiler = new _hydrationOpcodeCompiler2.default();
  this.hydrationCompiler = new _hydrationJavascriptCompiler2.default();
  this.templates = [];
  this.childTemplates = [];
}

exports.default = TemplateCompiler;

TemplateCompiler.prototype.compile = function (ast) {
  var templateVisitor = new _templateVisitor2.default();
  templateVisitor.visit(ast);

  _utils.processOpcodes(this, templateVisitor.actions);

  return this.templates.pop();
};

TemplateCompiler.prototype.startProgram = function (program, childTemplateCount, blankChildTextNodes) {
  this.fragmentOpcodeCompiler.startProgram(program, childTemplateCount, blankChildTextNodes);
  this.hydrationOpcodeCompiler.startProgram(program, childTemplateCount, blankChildTextNodes);

  this.childTemplates.length = 0;
  while (childTemplateCount--) {
    this.childTemplates.push(this.templates.pop());
  }
};

TemplateCompiler.prototype.insertBoundary = function (first) {
  this.hydrationOpcodeCompiler.insertBoundary(first);
};

TemplateCompiler.prototype.getChildTemplateVars = function (indent) {
  var vars = '';
  if (this.childTemplates) {
    for (var i = 0; i < this.childTemplates.length; i++) {
      vars += indent + 'var child' + i + ' = ' + this.childTemplates[i] + ';\n';
    }
  }
  return vars;
};

TemplateCompiler.prototype.getHydrationHooks = function (indent, hooks) {
  var hookVars = [];
  for (var hook in hooks) {
    hookVars.push(hook + ' = hooks.' + hook);
  }

  if (hookVars.length > 0) {
    return indent + 'var hooks = env.hooks, ' + hookVars.join(', ') + ';\n';
  } else {
    return '';
  }
};

TemplateCompiler.prototype.endProgram = function (program, programDepth) {
  this.fragmentOpcodeCompiler.endProgram(program);
  this.hydrationOpcodeCompiler.endProgram(program);

  var indent = _htmlbarsUtilQuoting.repeat("  ", programDepth);
  var options = {
    indent: indent + "    "
  };

  // function build(dom) { return fragment; }
  var fragmentProgram = this.fragmentCompiler.compile(this.fragmentOpcodeCompiler.opcodes, options);

  // function hydrate(fragment) { return mustaches; }
  var hydrationPrograms = this.hydrationCompiler.compile(this.hydrationOpcodeCompiler.opcodes, options);

  var blockParams = program.blockParams || [];

  var templateSignature = 'context, rootNode, env, options';
  if (blockParams.length > 0) {
    templateSignature += ', blockArguments';
  }

  var statements = _htmlbarsUtilArrayUtils.map(hydrationPrograms.statements, function (s) {
    return indent + '      ' + JSON.stringify(s);
  }).join(",\n");

  var locals = JSON.stringify(hydrationPrograms.locals);

  var templates = _htmlbarsUtilArrayUtils.map(this.childTemplates, function (_, index) {
    return 'child' + index;
  }).join(', ');

  var template = '(function() {\n' + this.getChildTemplateVars(indent + '  ') + indent + '  return {\n' + this.buildMeta(indent + '    ', program) + indent + '    isEmpty: ' + (program.body.length ? 'false' : 'true') + ',\n' + indent + '    arity: ' + blockParams.length + ',\n' + indent + '    cachedFragment: null,\n' + indent + '    hasRendered: false,\n' + indent + '    buildFragment: ' + fragmentProgram + ',\n' + indent + '    buildRenderNodes: ' + hydrationPrograms.createMorphsProgram + ',\n' + indent + '    statements: [\n' + statements + '\n' + indent + '    ],\n' + indent + '    locals: ' + locals + ',\n' + indent + '    templates: [' + templates + ']\n' + indent + '  };\n' + indent + '}())';

  this.templates.push(template);
};

TemplateCompiler.prototype.buildMeta = function (indent, program) {
  var meta = this.consumerBuildMeta(program) || {};

  var head = indent + 'meta: ';
  var stringMeta = JSON.stringify(meta, null, 2).replace(/\n/g, '\n' + indent);
  var tail = ',\n';

  return head + stringMeta + tail;
};

TemplateCompiler.prototype.openElement = function (element, i, l, r, c, b) {
  this.fragmentOpcodeCompiler.openElement(element, i, l, r, c, b);
  this.hydrationOpcodeCompiler.openElement(element, i, l, r, c, b);
};

TemplateCompiler.prototype.closeElement = function (element, i, l, r) {
  this.fragmentOpcodeCompiler.closeElement(element, i, l, r);
  this.hydrationOpcodeCompiler.closeElement(element, i, l, r);
};

TemplateCompiler.prototype.component = function (component, i, l, s) {
  this.fragmentOpcodeCompiler.component(component, i, l, s);
  this.hydrationOpcodeCompiler.component(component, i, l, s);
};

TemplateCompiler.prototype.block = function (block, i, l, s) {
  this.fragmentOpcodeCompiler.block(block, i, l, s);
  this.hydrationOpcodeCompiler.block(block, i, l, s);
};

TemplateCompiler.prototype.text = function (string, i, l, r) {
  this.fragmentOpcodeCompiler.text(string, i, l, r);
  this.hydrationOpcodeCompiler.text(string, i, l, r);
};

TemplateCompiler.prototype.comment = function (string, i, l, r) {
  this.fragmentOpcodeCompiler.comment(string, i, l, r);
  this.hydrationOpcodeCompiler.comment(string, i, l, r);
};

TemplateCompiler.prototype.mustache = function (mustache, i, l, s) {
  this.fragmentOpcodeCompiler.mustache(mustache, i, l, s);
  this.hydrationOpcodeCompiler.mustache(mustache, i, l, s);
};

TemplateCompiler.prototype.setNamespace = function (namespace) {
  this.fragmentOpcodeCompiler.setNamespace(namespace);
};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLWNvbXBpbGVyL3RlbXBsYXRlLWNvbXBpbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7c0NBQW1DLDRCQUE0Qjs7OzswQ0FDeEIsZ0NBQWdDOzs7O3VDQUNuQyw2QkFBNkI7Ozs7MkNBQ3pCLGlDQUFpQzs7OzsrQkFDN0Msb0JBQW9COzs7O3FCQUNqQixTQUFTOzttQ0FDakIsMEJBQTBCOztzQ0FDN0IsOEJBQThCOztBQUVsRCxTQUFTLGdCQUFnQixDQUFDLE9BQU8sRUFBRTtBQUNqQyxNQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7QUFDN0IsTUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLFlBQVcsRUFBRSxDQUFDO0FBQ2pFLE1BQUksQ0FBQyxzQkFBc0IsR0FBRyxzQ0FBNEIsQ0FBQztBQUMzRCxNQUFJLENBQUMsZ0JBQWdCLEdBQUcsMENBQWdDLENBQUM7QUFDekQsTUFBSSxDQUFDLHVCQUF1QixHQUFHLHVDQUE2QixDQUFDO0FBQzdELE1BQUksQ0FBQyxpQkFBaUIsR0FBRywyQ0FBaUMsQ0FBQztBQUMzRCxNQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztBQUNwQixNQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztDQUMxQjs7a0JBRWMsZ0JBQWdCOztBQUUvQixnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLFVBQVMsR0FBRyxFQUFFO0FBQ2pELE1BQUksZUFBZSxHQUFHLCtCQUFxQixDQUFDO0FBQzVDLGlCQUFlLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDOztBQUUzQix3QkFBZSxJQUFJLEVBQUUsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDOztBQUU5QyxTQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7Q0FDN0IsQ0FBQzs7QUFFRixnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHLFVB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QUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ2xELE1BQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Q0FDcEQsQ0FBQzs7QUFFRixnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLFVBQVMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQzdELE1BQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDckQsTUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztDQUN2RCxDQUFDOztBQUVGLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxRQUFRLEdBQUcsVUFBVSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDakUsTUFBSSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN4RCxNQUFJLENBQUMsdUJBQXVCLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0NBQzFELENBQUM7O0FBRUYsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRyxVQUFTLFNBQVMsRUFBRTtBQUM1RCxNQUFJLENBQUMsc0JBQXNCLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQ3JELENBQUMiLCJmaWxlIjoiaHRtbGJhcnMtY29tcGlsZXIvdGVtcGxhdGUtY29tcGlsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRnJhZ21lbnRPcGNvZGVDb21waWxlciBmcm9tICcuL2ZyYWdtZW50LW9wY29kZS1jb21waWxlcic7XG5pbXBvcnQgRnJhZ21lbnRKYXZhU2NyaXB0Q29tcGlsZXIgZnJvbSAnLi9mcmFnbWVudC1qYXZhc2NyaXB0LWNvbXBpbGVyJztcbmltcG9ydCBIeWRyYXRpb25PcGNvZGVDb21waWxlciBmcm9tICcuL2h5ZHJhdGlvbi1vcGNvZGUtY29tcGlsZXInO1xuaW1wb3J0IEh5ZHJhdGlvbkphdmFTY3JpcHRDb21waWxlciBmcm9tICcuL2h5ZHJhdGlvbi1qYXZhc2NyaXB0LWNvbXBpbGVyJztcbmltcG9ydCBUZW1wbGF0ZVZpc2l0b3IgZnJvbSBcIi4vdGVtcGxhdGUtdmlzaXRvclwiO1xuaW1wb3J0IHsgcHJvY2Vzc09wY29kZXMgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgcmVwZWF0IH0gZnJvbSBcIi4uL2h0bWxiYXJzLXV0aWwvcXVvdGluZ1wiO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSBcIi4uL2h0bWxiYXJzLXV0aWwvYXJyYXktdXRpbHNcIjtcblxuZnVuY3Rpb24gVGVtcGxhdGVDb21waWxlcihvcHRpb25zKSB7XG4gIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gIHRoaXMuY29uc3VtZXJCdWlsZE1ldGEgPSB0aGlzLm9wdGlvbnMuYnVpbGRNZXRhIHx8IGZ1bmN0aW9uKCkge307XG4gIHRoaXMuZnJhZ21lbnRPcGNvZGVDb21waWxlciA9IG5ldyBGcmFnbWVudE9wY29kZUNvbXBpbGVyKCk7XG4gIHRoaXMuZnJhZ21lbnRDb21waWxlciA9IG5ldyBGcmFnbWVudEphdmFTY3JpcHRDb21waWxlcigpO1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyID0gbmV3IEh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyKCk7XG4gIHRoaXMuaHlkcmF0aW9uQ29tcGlsZXIgPSBuZXcgSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyKCk7XG4gIHRoaXMudGVtcGxhdGVzID0gW107XG4gIHRoaXMuY2hpbGRUZW1wbGF0ZXMgPSBbXTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgVGVtcGxhdGVDb21waWxlcjtcblxuVGVtcGxhdGVDb21waWxlci5wcm90b3R5cGUuY29tcGlsZSA9IGZ1bmN0aW9uKGFzdCkge1xuICB2YXIgdGVtcGxhdGVWaXNpdG9yID0gbmV3IFRlbXBsYXRlVmlzaXRvcigpO1xuICB0ZW1wbGF0ZVZpc2l0b3IudmlzaXQoYXN0KTtcblxuICBwcm9jZXNzT3Bjb2Rlcyh0aGlzLCB0ZW1wbGF0ZVZpc2l0b3IuYWN0aW9ucyk7XG5cbiAgcmV0dXJuIHRoaXMudGVtcGxhdGVzLnBvcCgpO1xufTtcblxuVGVtcGxhdGVDb21waWxlci5wcm90b3R5cGUuc3RhcnRQcm9ncmFtID0gZnVuY3Rpb24ocHJvZ3JhbSwgY2hpbGRUZW1wbGF0ZUNvdW50LCBibGFua0NoaWxkVGV4dE5vZGVzKSB7XG4gIHRoaXMuZnJhZ21lbnRPcGNvZGVDb21waWxlci5zdGFydFByb2dyYW0ocHJvZ3JhbSwgY2hpbGRUZW1wbGF0ZUNvdW50LCBibGFua0NoaWxkVGV4dE5vZGVzKTtcbiAgdGhpcy5oeWRyYXRpb25PcGNvZGVDb21waWxlci5zdGFydFByb2dyYW0ocHJvZ3JhbSwgY2hpbGRUZW1wbGF0ZUNvdW50LCBibGFua0NoaWxkVGV4dE5vZGVzKTtcblxuICB0aGlzLmNoaWxkVGVtcGxhdGVzLmxlbmd0aCA9IDA7XG4gIHdoaWxlKGNoaWxkVGVtcGxhdGVDb3VudC0tKSB7XG4gICAgdGhpcy5jaGlsZFRlbXBsYXRlcy5wdXNoKHRoaXMudGVtcGxhdGVzLnBvcCgpKTtcbiAgfVxufTtcblxuVGVtcGxhdGVDb21waWxlci5wcm90b3R5cGUuaW5zZXJ0Qm91bmRhcnkgPSBmdW5jdGlvbihmaXJzdCkge1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLmluc2VydEJvdW5kYXJ5KGZpcnN0KTtcbn07XG5cblRlbXBsYXRlQ29tcGlsZXIucHJvdG90eXBlLmdldENoaWxkVGVtcGxhdGVWYXJzID0gZnVuY3Rpb24oaW5kZW50KSB7XG4gIHZhciB2YXJzID0gJyc7XG4gIGlmICh0aGlzLmNoaWxkVGVtcGxhdGVzKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkVGVtcGxhdGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YXJzICs9IGluZGVudCArICd2YXIgY2hpbGQnICsgaSArICcgPSAnICsgdGhpcy5jaGlsZFRlbXBsYXRlc1tpXSArICc7XFxuJztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHZhcnM7XG59O1xuXG5UZW1wbGF0ZUNvbXBpbGVyLnByb3RvdHlwZS5nZXRIeWRyYXRpb25Ib29rcyA9IGZ1bmN0aW9uKGluZGVudCwgaG9va3MpIHtcbiAgdmFyIGhvb2tWYXJzID0gW107XG4gIGZvciAodmFyIGhvb2sgaW4gaG9va3MpIHtcbiAgICBob29rVmFycy5wdXNoKGhvb2sgKyAnID0gaG9va3MuJyArIGhvb2spO1xuICB9XG5cbiAgaWYgKGhvb2tWYXJzLmxlbmd0aCA+IDApIHtcbiAgICByZXR1cm4gaW5kZW50ICsgJ3ZhciBob29rcyA9IGVudi5ob29rcywgJyArIGhvb2tWYXJzLmpvaW4oJywgJykgKyAnO1xcbic7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG59O1xuXG5UZW1wbGF0ZUNvbXBpbGVyLnByb3RvdHlwZS5lbmRQcm9ncmFtID0gZnVuY3Rpb24ocHJvZ3JhbSwgcHJvZ3JhbURlcHRoKSB7XG4gIHRoaXMuZnJhZ21lbnRPcGNvZGVDb21waWxlci5lbmRQcm9ncmFtKHByb2dyYW0pO1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLmVuZFByb2dyYW0ocHJvZ3JhbSk7XG5cbiAgdmFyIGluZGVudCA9IHJlcGVhdChcIiAgXCIsIHByb2dyYW1EZXB0aCk7XG4gIHZhciBvcHRpb25zID0ge1xuICAgIGluZGVudDogaW5kZW50ICsgXCIgICAgXCJcbiAgfTtcblxuICAvLyBmdW5jdGlvbiBidWlsZChkb20pIHsgcmV0dXJuIGZyYWdtZW50OyB9XG4gIHZhciBmcmFnbWVudFByb2dyYW0gPSB0aGlzLmZyYWdtZW50Q29tcGlsZXIuY29tcGlsZShcbiAgICB0aGlzLmZyYWdtZW50T3Bjb2RlQ29tcGlsZXIub3Bjb2RlcyxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgLy8gZnVuY3Rpb24gaHlkcmF0ZShmcmFnbWVudCkgeyByZXR1cm4gbXVzdGFjaGVzOyB9XG4gIHZhciBoeWRyYXRpb25Qcm9ncmFtcyA9IHRoaXMuaHlkcmF0aW9uQ29tcGlsZXIuY29tcGlsZShcbiAgICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLm9wY29kZXMsXG4gICAgb3B0aW9uc1xuICApO1xuXG4gIHZhciBibG9ja1BhcmFtcyA9IHByb2dyYW0uYmxvY2tQYXJhbXMgfHwgW107XG5cbiAgdmFyIHRlbXBsYXRlU2lnbmF0dXJlID0gJ2NvbnRleHQsIHJvb3ROb2RlLCBlbnYsIG9wdGlvbnMnO1xuICBpZiAoYmxvY2tQYXJhbXMubGVuZ3RoID4gMCkge1xuICAgIHRlbXBsYXRlU2lnbmF0dXJlICs9ICcsIGJsb2NrQXJndW1lbnRzJztcbiAgfVxuXG4gIHZhciBzdGF0ZW1lbnRzID0gbWFwKGh5ZHJhdGlvblByb2dyYW1zLnN0YXRlbWVudHMsIGZ1bmN0aW9uKHMpIHtcbiAgICByZXR1cm4gaW5kZW50KycgICAgICAnK0pTT04uc3RyaW5naWZ5KHMpO1xuICB9KS5qb2luKFwiLFxcblwiKTtcblxuICB2YXIgbG9jYWxzID0gSlNPTi5zdHJpbmdpZnkoaHlkcmF0aW9uUHJvZ3JhbXMubG9jYWxzKTtcblxuICB2YXIgdGVtcGxhdGVzID0gbWFwKHRoaXMuY2hpbGRUZW1wbGF0ZXMsIGZ1bmN0aW9uKF8sIGluZGV4KSB7XG4gICAgcmV0dXJuICdjaGlsZCcgKyBpbmRleDtcbiAgfSkuam9pbignLCAnKTtcblxuICB2YXIgdGVtcGxhdGUgPVxuICAgICcoZnVuY3Rpb24oKSB7XFxuJyArXG4gICAgdGhpcy5nZXRDaGlsZFRlbXBsYXRlVmFycyhpbmRlbnQgKyAnICAnKSArXG4gICAgaW5kZW50KycgIHJldHVybiB7XFxuJyArXG4gICAgdGhpcy5idWlsZE1ldGEoaW5kZW50KycgICAgJywgcHJvZ3JhbSkgK1xuICAgIGluZGVudCsnICAgIGlzRW1wdHk6ICcgKyAocHJvZ3JhbS5ib2R5Lmxlbmd0aCA/ICdmYWxzZScgOiAndHJ1ZScpICsgJyxcXG4nICtcbiAgICBpbmRlbnQrJyAgICBhcml0eTogJyArIGJsb2NrUGFyYW1zLmxlbmd0aCArICcsXFxuJyArXG4gICAgaW5kZW50KycgICAgY2FjaGVkRnJhZ21lbnQ6IG51bGwsXFxuJyArXG4gICAgaW5kZW50KycgICAgaGFzUmVuZGVyZWQ6IGZhbHNlLFxcbicgK1xuICAgIGluZGVudCsnICAgIGJ1aWxkRnJhZ21lbnQ6ICcgKyBmcmFnbWVudFByb2dyYW0gKyAnLFxcbicgK1xuICAgIGluZGVudCsnICAgIGJ1aWxkUmVuZGVyTm9kZXM6ICcgKyBoeWRyYXRpb25Qcm9ncmFtcy5jcmVhdGVNb3JwaHNQcm9ncmFtICsgJyxcXG4nICtcbiAgICBpbmRlbnQrJyAgICBzdGF0ZW1lbnRzOiBbXFxuJyArIHN0YXRlbWVudHMgKyAnXFxuJyArXG4gICAgaW5kZW50KycgICAgXSxcXG4nICtcbiAgICBpbmRlbnQrJyAgICBsb2NhbHM6ICcgKyBsb2NhbHMgKyAnLFxcbicgK1xuICAgIGluZGVudCsnICAgIHRlbXBsYXRlczogWycgKyB0ZW1wbGF0ZXMgKyAnXVxcbicgK1xuICAgIGluZGVudCsnICB9O1xcbicgK1xuICAgIGluZGVudCsnfSgpKSc7XG5cbiAgdGhpcy50ZW1wbGF0ZXMucHVzaCh0ZW1wbGF0ZSk7XG59O1xuXG5UZW1wbGF0ZUNvbXBpbGVyLnByb3RvdHlwZS5idWlsZE1ldGEgPSBmdW5jdGlvbihpbmRlbnQsIHByb2dyYW0pIHtcbiAgdmFyIG1ldGEgPSB0aGlzLmNvbnN1bWVyQnVpbGRNZXRhKHByb2dyYW0pIHx8IHt9O1xuXG4gIHZhciBoZWFkID0gaW5kZW50KydtZXRhOiAnO1xuICB2YXIgc3RyaW5nTWV0YSA9IEpTT04uc3RyaW5naWZ5KG1ldGEsIG51bGwsIDIpLnJlcGxhY2UoL1xcbi9nLCAnXFxuJyArIGluZGVudCk7XG4gIHZhciB0YWlsID0gJyxcXG4nO1xuXG4gIHJldHVybiBoZWFkICsgc3RyaW5nTWV0YSArIHRhaWw7XG59O1xuXG5UZW1wbGF0ZUNvbXBpbGVyLnByb3RvdHlwZS5vcGVuRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQsIGksIGwsIHIsIGMsIGIpIHtcbiAgdGhpcy5mcmFnbWVudE9wY29kZUNvbXBpbGVyLm9wZW5FbGVtZW50KGVsZW1lbnQsIGksIGwsIHIsIGMsIGIpO1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLm9wZW5FbGVtZW50KGVsZW1lbnQsIGksIGwsIHIsIGMsIGIpO1xufTtcblxuVGVtcGxhdGVDb21waWxlci5wcm90b3R5cGUuY2xvc2VFbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCwgaSwgbCwgcikge1xuICB0aGlzLmZyYWdtZW50T3Bjb2RlQ29tcGlsZXIuY2xvc2VFbGVtZW50KGVsZW1lbnQsIGksIGwsIHIpO1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLmNsb3NlRWxlbWVudChlbGVtZW50LCBpLCBsLCByKTtcbn07XG5cblRlbXBsYXRlQ29tcGlsZXIucHJvdG90eXBlLmNvbXBvbmVudCA9IGZ1bmN0aW9uKGNvbXBvbmVudCwgaSwgbCwgcykge1xuICB0aGlzLmZyYWdtZW50T3Bjb2RlQ29tcGlsZXIuY29tcG9uZW50KGNvbXBvbmVudCwgaSwgbCwgcyk7XG4gIHRoaXMuaHlkcmF0aW9uT3Bjb2RlQ29tcGlsZXIuY29tcG9uZW50KGNvbXBvbmVudCwgaSwgbCwgcyk7XG59O1xuXG5UZW1wbGF0ZUNvbXBpbGVyLnByb3RvdHlwZS5ibG9jayA9IGZ1bmN0aW9uKGJsb2NrLCBpLCBsLCBzKSB7XG4gIHRoaXMuZnJhZ21lbnRPcGNvZGVDb21waWxlci5ibG9jayhibG9jaywgaSwgbCwgcyk7XG4gIHRoaXMuaHlkcmF0aW9uT3Bjb2RlQ29tcGlsZXIuYmxvY2soYmxvY2ssIGksIGwsIHMpO1xufTtcblxuVGVtcGxhdGVDb21waWxlci5wcm90b3R5cGUudGV4dCA9IGZ1bmN0aW9uKHN0cmluZywgaSwgbCwgcikge1xuICB0aGlzLmZyYWdtZW50T3Bjb2RlQ29tcGlsZXIudGV4dChzdHJpbmcsIGksIGwsIHIpO1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLnRleHQoc3RyaW5nLCBpLCBsLCByKTtcbn07XG5cblRlbXBsYXRlQ29tcGlsZXIucHJvdG90eXBlLmNvbW1lbnQgPSBmdW5jdGlvbihzdHJpbmcsIGksIGwsIHIpIHtcbiAgdGhpcy5mcmFnbWVudE9wY29kZUNvbXBpbGVyLmNvbW1lbnQoc3RyaW5nLCBpLCBsLCByKTtcbiAgdGhpcy5oeWRyYXRpb25PcGNvZGVDb21waWxlci5jb21tZW50KHN0cmluZywgaSwgbCwgcik7XG59O1xuXG5UZW1wbGF0ZUNvbXBpbGVyLnByb3RvdHlwZS5tdXN0YWNoZSA9IGZ1bmN0aW9uIChtdXN0YWNoZSwgaSwgbCwgcykge1xuICB0aGlzLmZyYWdtZW50T3Bjb2RlQ29tcGlsZXIubXVzdGFjaGUobXVzdGFjaGUsIGksIGwsIHMpO1xuICB0aGlzLmh5ZHJhdGlvbk9wY29kZUNvbXBpbGVyLm11c3RhY2hlKG11c3RhY2hlLCBpLCBsLCBzKTtcbn07XG5cblRlbXBsYXRlQ29tcGlsZXIucHJvdG90eXBlLnNldE5hbWVzcGFjZSA9IGZ1bmN0aW9uKG5hbWVzcGFjZSkge1xuICB0aGlzLmZyYWdtZW50T3Bjb2RlQ29tcGlsZXIuc2V0TmFtZXNwYWNlKG5hbWVzcGFjZSk7XG59O1xuIl19