exports.__esModule = true;

var _morphRangeUtils = require('./morph-range/utils');

// constructor just initializes the fields
// use one of the static initializers to create a valid morph.
function Morph(domHelper, contextualElement) {
  this.domHelper = domHelper;
  // context if content if current content is detached
  this.contextualElement = contextualElement;
  // inclusive range of morph
  // these should be nodeType 1, 3, or 8
  this.firstNode = null;
  this.lastNode = null;

  // flag to force text to setContent to be treated as html
  this.parseTextAsHTML = false;

  // morph list graph
  this.parentMorphList = null;
  this.previousMorph = null;
  this.nextMorph = null;
}

Morph.empty = function (domHelper, contextualElement) {
  var morph = new Morph(domHelper, contextualElement);
  morph.clear();
  return morph;
};

Morph.create = function (domHelper, contextualElement, node) {
  var morph = new Morph(domHelper, contextualElement);
  morph.setNode(node);
  return morph;
};

Morph.attach = function (domHelper, contextualElement, firstNode, lastNode) {
  var morph = new Morph(domHelper, contextualElement);
  morph.setRange(firstNode, lastNode);
  return morph;
};

Morph.prototype.setContent = function Morph$setContent(content) {
  if (content === null || content === undefined) {
    return this.clear();
  }

  var type = typeof content;
  switch (type) {
    case 'string':
      if (this.parseTextAsHTML) {
        return this.domHelper.setMorphHTML(this, content);
      }
      return this.setText(content);
    case 'object':
      if (typeof content.nodeType === 'number') {
        return this.setNode(content);
      }
      /* Handlebars.SafeString */
      if (typeof content.string === 'string') {
        return this.setHTML(content.string);
      }
      if (this.parseTextAsHTML) {
        return this.setHTML(content.toString());
      }
    /* falls through */
    case 'boolean':
    case 'number':
      return this.setText(content.toString());
    case 'function':
      raiseCannotBindToFunction(content);
    default:
      throw new TypeError('unsupported content');
  }
};

function raiseCannotBindToFunction(content) {
  var functionName = content.name;
  var message;

  if (functionName) {
    message = 'Unsupported Content: Cannot bind to function `' + functionName + '`';
  } else {
    message = 'Unsupported Content: Cannot bind to function';
  }

  throw new TypeError(message);
}

Morph.prototype.clear = function Morph$clear() {
  var node = this.setNode(this.domHelper.createComment(''));
  return node;
};

Morph.prototype.setText = function Morph$setText(text) {
  var firstNode = this.firstNode;
  var lastNode = this.lastNode;

  if (firstNode && lastNode === firstNode && firstNode.nodeType === 3) {
    firstNode.nodeValue = text;
    return firstNode;
  }

  return this.setNode(text ? this.domHelper.createTextNode(text) : this.domHelper.createComment(''));
};

Morph.prototype.setNode = function Morph$setNode(newNode) {
  var firstNode, lastNode;
  switch (newNode.nodeType) {
    case 3:
      firstNode = newNode;
      lastNode = newNode;
      break;
    case 11:
      firstNode = newNode.firstChild;
      lastNode = newNode.lastChild;
      if (firstNode === null) {
        firstNode = this.domHelper.createComment('');
        newNode.appendChild(firstNode);
        lastNode = firstNode;
      }
      break;
    default:
      firstNode = newNode;
      lastNode = newNode;
      break;
  }

  this.setRange(firstNode, lastNode);

  return newNode;
};

Morph.prototype.setRange = function (firstNode, lastNode) {
  var previousFirstNode = this.firstNode;
  if (previousFirstNode !== null) {

    var parentNode = previousFirstNode.parentNode;
    if (parentNode !== null) {
      _morphRangeUtils.insertBefore(parentNode, firstNode, lastNode, previousFirstNode);
      _morphRangeUtils.clear(parentNode, previousFirstNode, this.lastNode);
    }
  }

  this.firstNode = firstNode;
  this.lastNode = lastNode;

  if (this.parentMorphList) {
    this._syncFirstNode();
    this._syncLastNode();
  }
};

Morph.prototype.destroy = function Morph$destroy() {
  this.unlink();

  var firstNode = this.firstNode;
  var lastNode = this.lastNode;
  var parentNode = firstNode && firstNode.parentNode;

  this.firstNode = null;
  this.lastNode = null;

  _morphRangeUtils.clear(parentNode, firstNode, lastNode);
};

Morph.prototype.unlink = function Morph$unlink() {
  var parentMorphList = this.parentMorphList;
  var previousMorph = this.previousMorph;
  var nextMorph = this.nextMorph;

  if (previousMorph) {
    if (nextMorph) {
      previousMorph.nextMorph = nextMorph;
      nextMorph.previousMorph = previousMorph;
    } else {
      previousMorph.nextMorph = null;
      parentMorphList.lastChildMorph = previousMorph;
    }
  } else {
    if (nextMorph) {
      nextMorph.previousMorph = null;
      parentMorphList.firstChildMorph = nextMorph;
    } else if (parentMorphList) {
      parentMorphList.lastChildMorph = parentMorphList.firstChildMorph = null;
    }
  }

  this.parentMorphList = null;
  this.nextMorph = null;
  this.previousMorph = null;

  if (parentMorphList && parentMorphList.mountedMorph) {
    if (!parentMorphList.firstChildMorph) {
      // list is empty
      parentMorphList.mountedMorph.clear();
      return;
    } else {
      parentMorphList.firstChildMorph._syncFirstNode();
      parentMorphList.lastChildMorph._syncLastNode();
    }
  }
};

Morph.prototype.setHTML = function (text) {
  var fragment = this.domHelper.parseHTML(text, this.contextualElement);
  return this.setNode(fragment);
};

Morph.prototype.setMorphList = function Morph$appendMorphList(morphList) {
  morphList.mountedMorph = this;
  this.clear();

  var originalFirstNode = this.firstNode;

  if (morphList.firstChildMorph) {
    this.firstNode = morphList.firstChildMorph.firstNode;
    this.lastNode = morphList.lastChildMorph.lastNode;

    var current = morphList.firstChildMorph;

    while (current) {
      var next = current.nextMorph;
      current.insertBeforeNode(originalFirstNode, null);
      current = next;
    }
    originalFirstNode.parentNode.removeChild(originalFirstNode);
  }
};

Morph.prototype._syncFirstNode = function Morph$syncFirstNode() {
  var morph = this;
  var parentMorphList;
  while (parentMorphList = morph.parentMorphList) {
    if (parentMorphList.mountedMorph === null) {
      break;
    }
    if (morph !== parentMorphList.firstChildMorph) {
      break;
    }
    if (morph.firstNode === parentMorphList.mountedMorph.firstNode) {
      break;
    }

    parentMorphList.mountedMorph.firstNode = morph.firstNode;

    morph = parentMorphList.mountedMorph;
  }
};

Morph.prototype._syncLastNode = function Morph$syncLastNode() {
  var morph = this;
  var parentMorphList;
  while (parentMorphList = morph.parentMorphList) {
    if (parentMorphList.mountedMorph === null) {
      break;
    }
    if (morph !== parentMorphList.lastChildMorph) {
      break;
    }
    if (morph.lastNode === parentMorphList.mountedMorph.lastNode) {
      break;
    }

    parentMorphList.mountedMorph.lastNode = morph.lastNode;

    morph = parentMorphList.mountedMorph;
  }
};

Morph.prototype.insertBeforeNode = function Morph$insertBeforeNode(parentNode, refNode) {
  _morphRangeUtils.insertBefore(parentNode, this.firstNode, this.lastNode, refNode);
};

Morph.prototype.appendToNode = function Morph$appendToNode(parentNode) {
  _morphRangeUtils.insertBefore(parentNode, this.firstNode, this.lastNode, null);
};

exports.default = Morph;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vcnBoLXJhbmdlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OytCQUFvQyxxQkFBcUI7Ozs7QUFJekQsU0FBUyxLQUFLLENBQUMsU0FBUyxFQUFFLGlCQUFpQixFQUFFO0FBQzNDLE1BQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDOztBQUUzQixNQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7OztBQUczQyxNQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUN0QixNQUFJLENBQUMsUUFBUSxHQUFJLElBQUksQ0FBQzs7O0FBR3RCLE1BQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDOzs7QUFHN0IsTUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFDNUIsTUFBSSxDQUFDLGFBQWEsR0FBSyxJQUFJLENBQUM7QUFDNUIsTUFBSSxDQUFDLFNBQVMsR0FBUyxJQUFJLENBQUM7Q0FDN0I7O0FBRUQsS0FBSyxDQUFDLEtBQUssR0FBRyxVQUFVLFNBQVMsRUFBRSxpQkFBaUIsRUFBRTtBQUNwRCxNQUFJLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztBQUNwRCxPQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDZCxTQUFPLEtBQUssQ0FBQztDQUNkLENBQUM7O0FBRUYsS0FBSyxDQUFDLE1BQU0sR0FBRyxVQUFVLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEVBQUU7QUFDM0QsTUFBSSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLGlCQUFpQixDQUFDLENBQUM7QUFDcEQsT0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNwQixTQUFPLEtBQUssQ0FBQztDQUNkLENBQUM7O0FBRUYsS0FBSyxDQUFDLE1BQU0sR0FBRyxVQUFVLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFO0FBQzFFLE1BQUksS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3BELE9BQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3BDLFNBQU8sS0FBSyxDQUFDO0NBQ2QsQ0FBQzs7QUFFRixLQUFLLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxTQUFTLGdCQUFnQixDQUFDLE9BQU8sRUFBRTtBQUM5RCxNQUFJLE9BQU8sS0FBSyxJQUFJLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtBQUM3QyxXQUFPLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztHQUNyQjs7QUFFRCxNQUFJLElBQUksR0FBRyxPQUFPLE9BQU8sQ0FBQztBQUMxQixVQUFRLElBQUk7QUFDVixTQUFLLFFBQVE7QUFDWCxVQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7QUFDeEIsZUFBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7T0FDbkQ7QUFDRCxhQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFBQSxBQUMvQixTQUFLLFFBQVE7QUFDWCxVQUFJLE9BQU8sT0FBTyxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUU7QUFDeEMsZUFBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO09BQzlCOztBQUVELFVBQUksT0FBTyxPQUFPLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFBRTtBQUN0QyxlQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO09BQ3JDO0FBQ0QsVUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO0FBQ3hCLGVBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztPQUN6QztBQUFBO0FBRUgsU0FBSyxTQUFTLENBQUM7QUFDZixTQUFLLFFBQVE7QUFDWCxhQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7QUFBQSxBQUMxQyxTQUFLLFVBQVU7QUFDYiwrQkFBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUFBLEFBQ3JDO0FBQ0UsWUFBTSxJQUFJLFNBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQUEsR0FDOUM7Q0FDRixDQUFDOztBQUVGLFNBQVMseUJBQXlCLENBQUMsT0FBTyxFQUFFO0FBQzFDLE1BQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDaEMsTUFBSSxPQUFPLENBQUM7O0FBRVosTUFBSSxZQUFZLEVBQUU7QUFDaEIsV0FBTyxHQUFHLGdEQUFnRCxHQUFHLFlBQVksR0FBRyxHQUFHLENBQUM7R0FDakYsTUFBTTtBQUNMLFdBQU8sR0FBRyw4Q0FBOEMsQ0FBQztHQUMxRDs7QUFFRCxRQUFNLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0NBQzlCOztBQUVELEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLFNBQVMsV0FBVyxHQUFHO0FBQzdDLE1BQUksSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUMxRCxTQUFPLElBQUksQ0FBQztDQUNiLENBQUM7O0FBRUYsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsU0FBUyxhQUFhLENBQUMsSUFBSSxFQUFFO0FBQ3JELE1BQUksU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7QUFDL0IsTUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQzs7QUFFN0IsTUFBSSxTQUFTLElBQ1QsUUFBUSxLQUFLLFNBQVMsSUFDdEIsU0FBUyxDQUFDLFFBQVEsS0FBSyxDQUFDLEVBQUU7QUFDNUIsYUFBUyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDM0IsV0FBTyxTQUFTLENBQUM7R0FDbEI7O0FBRUQsU0FBTyxJQUFJLENBQUMsT0FBTyxDQUNqQixJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQzlFLENBQUM7Q0FDSCxDQUFDOztBQUVGLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLFNBQVMsYUFBYSxDQUFDLE9BQU8sRUFBRTtBQUN4RCxNQUFJLFNBQVMsRUFBRSxRQUFRLENBQUM7QUFDeEIsVUFBUSxPQUFPLENBQUMsUUFBUTtBQUN0QixTQUFLLENBQUM7QUFDSixlQUFTLEdBQUcsT0FBTyxDQUFDO0FBQ3BCLGNBQVEsR0FBRyxPQUFPLENBQUM7QUFDbkIsWUFBTTtBQUFBLEFBQ1IsU0FBSyxFQUFFO0FBQ0wsZUFBUyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDL0IsY0FBUSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUM7QUFDN0IsVUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO0FBQ3RCLGlCQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDN0MsZUFBTyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvQixnQkFBUSxHQUFHLFNBQVMsQ0FBQztPQUN0QjtBQUNELFlBQU07QUFBQSxBQUNSO0FBQ0UsZUFBUyxHQUFHLE9BQU8sQ0FBQztBQUNwQixjQUFRLEdBQUcsT0FBTyxDQUFDO0FBQ25CLFlBQU07QUFBQSxHQUNUOztBQUVELE1BQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDOztBQUVuQyxTQUFPLE9BQU8sQ0FBQztDQUNoQixDQUFDOztBQUVGLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxHQUFHLFVBQVUsU0FBUyxFQUFFLFFBQVEsRUFBRTtBQUN4RCxNQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7QUFDdkMsTUFBSSxpQkFBaUIsS0FBSyxJQUFJLEVBQUU7O0FBRTlCLFFBQUksVUFBVSxHQUFHLGlCQUFpQixDQUFDLFVBQVUsQ0FBQztBQUM5QyxRQUFJLFVBQVUsS0FBSyxJQUFJLEVBQUU7QUFDdkIsb0NBQWEsVUFBVSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztBQUNqRSw2QkFBTSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ3JEO0dBQ0Y7O0FBRUQsTUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFDM0IsTUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7O0FBRXpCLE1BQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtBQUN4QixRQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDdEIsUUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0dBQ3RCO0NBQ0YsQ0FBQzs7QUFFRixLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sR0FBRyxTQUFTLGFBQWEsR0FBRztBQUNqRCxNQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7O0FBRWQsTUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztBQUMvQixNQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQzdCLE1BQUksVUFBVSxHQUFHLFNBQVMsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDOztBQUVuRCxNQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUN0QixNQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQzs7QUFFckIseUJBQU0sVUFBVSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztDQUN4QyxDQUFDOztBQUVGLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLFNBQVMsWUFBWSxHQUFHO0FBQy9DLE1BQUksZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7QUFDM0MsTUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztBQUN2QyxNQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDOztBQUUvQixNQUFJLGFBQWEsRUFBRTtBQUNqQixRQUFJLFNBQVMsRUFBRTtBQUNiLG1CQUFhLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztBQUNwQyxlQUFTLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztLQUN6QyxNQUFNO0FBQ0wsbUJBQWEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO0FBQy9CLHFCQUFlLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQztLQUNoRDtHQUNGLE1BQU07QUFDTCxRQUFJLFNBQVMsRUFBRTtBQUNiLGVBQVMsQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0FBQy9CLHFCQUFlLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztLQUM3QyxNQUFNLElBQUksZUFBZSxFQUFFO0FBQzFCLHFCQUFlLENBQUMsY0FBYyxHQUFHLGVBQWUsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO0tBQ3pFO0dBQ0Y7O0FBRUQsTUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFDNUIsTUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDdEIsTUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7O0FBRTFCLE1BQUksZUFBZSxJQUFJLGVBQWUsQ0FBQyxZQUFZLEVBQUU7QUFDbkQsUUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUU7O0FBRXBDLHFCQUFlLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3JDLGFBQU87S0FDUixNQUFNO0FBQ0wscUJBQWUsQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDakQscUJBQWUsQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7S0FDaEQ7R0FDRjtDQUNGLENBQUM7O0FBRUYsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBUyxJQUFJLEVBQUU7QUFDdkMsTUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3RFLFNBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztDQUMvQixDQUFDOztBQUVGLEtBQUssQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHLFNBQVMscUJBQXFCLENBQUMsU0FBUyxFQUFFO0FBQ3ZFLFdBQVMsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBQzlCLE1BQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQzs7QUFFYixNQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7O0FBRXZDLE1BQUksU0FBUyxDQUFDLGVBQWUsRUFBRTtBQUM3QixRQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDO0FBQ3JELFFBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUM7O0FBRWxELFFBQUksT0FBTyxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUM7O0FBRXhDLFdBQU8sT0FBTyxFQUFFO0FBQ2QsVUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztBQUM3QixhQUFPLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDbEQsYUFBTyxHQUFHLElBQUksQ0FBQztLQUNoQjtBQUNELHFCQUFpQixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsQ0FBQztHQUM3RDtDQUNGLENBQUM7O0FBRUYsS0FBSyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsU0FBUyxtQkFBbUIsR0FBRztBQUM5RCxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDakIsTUFBSSxlQUFlLENBQUM7QUFDcEIsU0FBTyxlQUFlLEdBQUcsS0FBSyxDQUFDLGVBQWUsRUFBRTtBQUM5QyxRQUFJLGVBQWUsQ0FBQyxZQUFZLEtBQUssSUFBSSxFQUFFO0FBQ3pDLFlBQU07S0FDUDtBQUNELFFBQUksS0FBSyxLQUFLLGVBQWUsQ0FBQyxlQUFlLEVBQUU7QUFDN0MsWUFBTTtLQUNQO0FBQ0QsUUFBSSxLQUFLLENBQUMsU0FBUyxLQUFLLGVBQWUsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFO0FBQzlELFlBQU07S0FDUDs7QUFFRCxtQkFBZSxDQUFDLFlBQVksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQzs7QUFFekQsU0FBSyxHQUFHLGVBQWUsQ0FBQyxZQUFZLENBQUM7R0FDdEM7Q0FDRixDQUFDOztBQUVGLEtBQUssQ0FBQyxTQUFTLENBQUMsYUFBYSxHQUFHLFNBQVMsa0JBQWtCLEdBQUc7QUFDNUQsTUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLE1BQUksZUFBZSxDQUFDO0FBQ3BCLFNBQU8sZUFBZSxHQUFHLEtBQUssQ0FBQyxlQUFlLEVBQUU7QUFDOUMsUUFBSSxlQUFlLENBQUMsWUFBWSxLQUFLLElBQUksRUFBRTtBQUN6QyxZQUFNO0tBQ1A7QUFDRCxRQUFJLEtBQUssS0FBSyxlQUFlLENBQUMsY0FBYyxFQUFFO0FBQzVDLFlBQU07S0FDUDtBQUNELFFBQUksS0FBSyxDQUFDLFFBQVEsS0FBSyxlQUFlLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRTtBQUM1RCxZQUFNO0tBQ1A7O0FBRUQsbUJBQWUsQ0FBQyxZQUFZLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7O0FBRXZELFNBQUssR0FBRyxlQUFlLENBQUMsWUFBWSxDQUFDO0dBQ3RDO0NBQ0YsQ0FBQzs7QUFFRixLQUFLLENBQUMsU0FBUyxDQUFDLGdCQUFnQixHQUFHLFNBQVMsc0JBQXNCLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRTtBQUN0RixnQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0NBQ2xFLENBQUM7O0FBRUYsS0FBSyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsU0FBUyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUU7QUFDckUsZ0NBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztDQUMvRCxDQUFDOztrQkFFYSxLQUFLIiwiZmlsZSI6Im1vcnBoLXJhbmdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2xlYXIsIGluc2VydEJlZm9yZSB9IGZyb20gJy4vbW9ycGgtcmFuZ2UvdXRpbHMnO1xuXG4vLyBjb25zdHJ1Y3RvciBqdXN0IGluaXRpYWxpemVzIHRoZSBmaWVsZHNcbi8vIHVzZSBvbmUgb2YgdGhlIHN0YXRpYyBpbml0aWFsaXplcnMgdG8gY3JlYXRlIGEgdmFsaWQgbW9ycGguXG5mdW5jdGlvbiBNb3JwaChkb21IZWxwZXIsIGNvbnRleHR1YWxFbGVtZW50KSB7XG4gIHRoaXMuZG9tSGVscGVyID0gZG9tSGVscGVyO1xuICAvLyBjb250ZXh0IGlmIGNvbnRlbnQgaWYgY3VycmVudCBjb250ZW50IGlzIGRldGFjaGVkXG4gIHRoaXMuY29udGV4dHVhbEVsZW1lbnQgPSBjb250ZXh0dWFsRWxlbWVudDtcbiAgLy8gaW5jbHVzaXZlIHJhbmdlIG9mIG1vcnBoXG4gIC8vIHRoZXNlIHNob3VsZCBiZSBub2RlVHlwZSAxLCAzLCBvciA4XG4gIHRoaXMuZmlyc3ROb2RlID0gbnVsbDtcbiAgdGhpcy5sYXN0Tm9kZSAgPSBudWxsO1xuXG4gIC8vIGZsYWcgdG8gZm9yY2UgdGV4dCB0byBzZXRDb250ZW50IHRvIGJlIHRyZWF0ZWQgYXMgaHRtbFxuICB0aGlzLnBhcnNlVGV4dEFzSFRNTCA9IGZhbHNlO1xuXG4gIC8vIG1vcnBoIGxpc3QgZ3JhcGhcbiAgdGhpcy5wYXJlbnRNb3JwaExpc3QgPSBudWxsO1xuICB0aGlzLnByZXZpb3VzTW9ycGggICA9IG51bGw7XG4gIHRoaXMubmV4dE1vcnBoICAgICAgID0gbnVsbDtcbn1cblxuTW9ycGguZW1wdHkgPSBmdW5jdGlvbiAoZG9tSGVscGVyLCBjb250ZXh0dWFsRWxlbWVudCkge1xuICB2YXIgbW9ycGggPSBuZXcgTW9ycGgoZG9tSGVscGVyLCBjb250ZXh0dWFsRWxlbWVudCk7XG4gIG1vcnBoLmNsZWFyKCk7XG4gIHJldHVybiBtb3JwaDtcbn07XG5cbk1vcnBoLmNyZWF0ZSA9IGZ1bmN0aW9uIChkb21IZWxwZXIsIGNvbnRleHR1YWxFbGVtZW50LCBub2RlKSB7XG4gIHZhciBtb3JwaCA9IG5ldyBNb3JwaChkb21IZWxwZXIsIGNvbnRleHR1YWxFbGVtZW50KTtcbiAgbW9ycGguc2V0Tm9kZShub2RlKTtcbiAgcmV0dXJuIG1vcnBoO1xufTtcblxuTW9ycGguYXR0YWNoID0gZnVuY3Rpb24gKGRvbUhlbHBlciwgY29udGV4dHVhbEVsZW1lbnQsIGZpcnN0Tm9kZSwgbGFzdE5vZGUpIHtcbiAgdmFyIG1vcnBoID0gbmV3IE1vcnBoKGRvbUhlbHBlciwgY29udGV4dHVhbEVsZW1lbnQpO1xuICBtb3JwaC5zZXRSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlKTtcbiAgcmV0dXJuIG1vcnBoO1xufTtcblxuTW9ycGgucHJvdG90eXBlLnNldENvbnRlbnQgPSBmdW5jdGlvbiBNb3JwaCRzZXRDb250ZW50KGNvbnRlbnQpIHtcbiAgaWYgKGNvbnRlbnQgPT09IG51bGwgfHwgY29udGVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIHRoaXMuY2xlYXIoKTtcbiAgfVxuXG4gIHZhciB0eXBlID0gdHlwZW9mIGNvbnRlbnQ7XG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICBpZiAodGhpcy5wYXJzZVRleHRBc0hUTUwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9tSGVscGVyLnNldE1vcnBoSFRNTCh0aGlzLCBjb250ZW50KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLnNldFRleHQoY29udGVudCk7XG4gICAgY2FzZSAnb2JqZWN0JzpcbiAgICAgIGlmICh0eXBlb2YgY29udGVudC5ub2RlVHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0Tm9kZShjb250ZW50KTtcbiAgICAgIH1cbiAgICAgIC8qIEhhbmRsZWJhcnMuU2FmZVN0cmluZyAqL1xuICAgICAgaWYgKHR5cGVvZiBjb250ZW50LnN0cmluZyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0SFRNTChjb250ZW50LnN0cmluZyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wYXJzZVRleHRBc0hUTUwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0SFRNTChjb250ZW50LnRvU3RyaW5nKCkpO1xuICAgICAgfVxuICAgICAgLyogZmFsbHMgdGhyb3VnaCAqL1xuICAgIGNhc2UgJ2Jvb2xlYW4nOlxuICAgIGNhc2UgJ251bWJlcic6XG4gICAgICByZXR1cm4gdGhpcy5zZXRUZXh0KGNvbnRlbnQudG9TdHJpbmcoKSk7XG4gICAgY2FzZSAnZnVuY3Rpb24nOlxuICAgICAgcmFpc2VDYW5ub3RCaW5kVG9GdW5jdGlvbihjb250ZW50KTtcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndW5zdXBwb3J0ZWQgY29udGVudCcpO1xuICB9XG59O1xuXG5mdW5jdGlvbiByYWlzZUNhbm5vdEJpbmRUb0Z1bmN0aW9uKGNvbnRlbnQpIHtcbiAgdmFyIGZ1bmN0aW9uTmFtZSA9IGNvbnRlbnQubmFtZTtcbiAgdmFyIG1lc3NhZ2U7XG5cbiAgaWYgKGZ1bmN0aW9uTmFtZSkge1xuICAgIG1lc3NhZ2UgPSAnVW5zdXBwb3J0ZWQgQ29udGVudDogQ2Fubm90IGJpbmQgdG8gZnVuY3Rpb24gYCcgKyBmdW5jdGlvbk5hbWUgKyAnYCc7XG4gIH0gZWxzZSB7XG4gICAgbWVzc2FnZSA9ICdVbnN1cHBvcnRlZCBDb250ZW50OiBDYW5ub3QgYmluZCB0byBmdW5jdGlvbic7XG4gIH1cblxuICB0aHJvdyBuZXcgVHlwZUVycm9yKG1lc3NhZ2UpO1xufVxuXG5Nb3JwaC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiBNb3JwaCRjbGVhcigpIHtcbiAgdmFyIG5vZGUgPSB0aGlzLnNldE5vZGUodGhpcy5kb21IZWxwZXIuY3JlYXRlQ29tbWVudCgnJykpO1xuICByZXR1cm4gbm9kZTtcbn07XG5cbk1vcnBoLnByb3RvdHlwZS5zZXRUZXh0ID0gZnVuY3Rpb24gTW9ycGgkc2V0VGV4dCh0ZXh0KSB7XG4gIHZhciBmaXJzdE5vZGUgPSB0aGlzLmZpcnN0Tm9kZTtcbiAgdmFyIGxhc3ROb2RlID0gdGhpcy5sYXN0Tm9kZTtcblxuICBpZiAoZmlyc3ROb2RlICYmXG4gICAgICBsYXN0Tm9kZSA9PT0gZmlyc3ROb2RlICYmXG4gICAgICBmaXJzdE5vZGUubm9kZVR5cGUgPT09IDMpIHtcbiAgICBmaXJzdE5vZGUubm9kZVZhbHVlID0gdGV4dDtcbiAgICByZXR1cm4gZmlyc3ROb2RlO1xuICB9XG5cbiAgcmV0dXJuIHRoaXMuc2V0Tm9kZShcbiAgICB0ZXh0ID8gdGhpcy5kb21IZWxwZXIuY3JlYXRlVGV4dE5vZGUodGV4dCkgOiB0aGlzLmRvbUhlbHBlci5jcmVhdGVDb21tZW50KCcnKVxuICApO1xufTtcblxuTW9ycGgucHJvdG90eXBlLnNldE5vZGUgPSBmdW5jdGlvbiBNb3JwaCRzZXROb2RlKG5ld05vZGUpIHtcbiAgdmFyIGZpcnN0Tm9kZSwgbGFzdE5vZGU7XG4gIHN3aXRjaCAobmV3Tm9kZS5ub2RlVHlwZSkge1xuICAgIGNhc2UgMzpcbiAgICAgIGZpcnN0Tm9kZSA9IG5ld05vZGU7XG4gICAgICBsYXN0Tm9kZSA9IG5ld05vZGU7XG4gICAgICBicmVhaztcbiAgICBjYXNlIDExOlxuICAgICAgZmlyc3ROb2RlID0gbmV3Tm9kZS5maXJzdENoaWxkO1xuICAgICAgbGFzdE5vZGUgPSBuZXdOb2RlLmxhc3RDaGlsZDtcbiAgICAgIGlmIChmaXJzdE5vZGUgPT09IG51bGwpIHtcbiAgICAgICAgZmlyc3ROb2RlID0gdGhpcy5kb21IZWxwZXIuY3JlYXRlQ29tbWVudCgnJyk7XG4gICAgICAgIG5ld05vZGUuYXBwZW5kQ2hpbGQoZmlyc3ROb2RlKTtcbiAgICAgICAgbGFzdE5vZGUgPSBmaXJzdE5vZGU7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgZmlyc3ROb2RlID0gbmV3Tm9kZTtcbiAgICAgIGxhc3ROb2RlID0gbmV3Tm9kZTtcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgdGhpcy5zZXRSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlKTtcblxuICByZXR1cm4gbmV3Tm9kZTtcbn07XG5cbk1vcnBoLnByb3RvdHlwZS5zZXRSYW5nZSA9IGZ1bmN0aW9uIChmaXJzdE5vZGUsIGxhc3ROb2RlKSB7XG4gIHZhciBwcmV2aW91c0ZpcnN0Tm9kZSA9IHRoaXMuZmlyc3ROb2RlO1xuICBpZiAocHJldmlvdXNGaXJzdE5vZGUgIT09IG51bGwpIHtcblxuICAgIHZhciBwYXJlbnROb2RlID0gcHJldmlvdXNGaXJzdE5vZGUucGFyZW50Tm9kZTtcbiAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkge1xuICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudE5vZGUsIGZpcnN0Tm9kZSwgbGFzdE5vZGUsIHByZXZpb3VzRmlyc3ROb2RlKTtcbiAgICAgIGNsZWFyKHBhcmVudE5vZGUsIHByZXZpb3VzRmlyc3ROb2RlLCB0aGlzLmxhc3ROb2RlKTtcbiAgICB9XG4gIH1cblxuICB0aGlzLmZpcnN0Tm9kZSA9IGZpcnN0Tm9kZTtcbiAgdGhpcy5sYXN0Tm9kZSA9IGxhc3ROb2RlO1xuXG4gIGlmICh0aGlzLnBhcmVudE1vcnBoTGlzdCkge1xuICAgIHRoaXMuX3N5bmNGaXJzdE5vZGUoKTtcbiAgICB0aGlzLl9zeW5jTGFzdE5vZGUoKTtcbiAgfVxufTtcblxuTW9ycGgucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiBNb3JwaCRkZXN0cm95KCkge1xuICB0aGlzLnVubGluaygpO1xuXG4gIHZhciBmaXJzdE5vZGUgPSB0aGlzLmZpcnN0Tm9kZTtcbiAgdmFyIGxhc3ROb2RlID0gdGhpcy5sYXN0Tm9kZTtcbiAgdmFyIHBhcmVudE5vZGUgPSBmaXJzdE5vZGUgJiYgZmlyc3ROb2RlLnBhcmVudE5vZGU7XG5cbiAgdGhpcy5maXJzdE5vZGUgPSBudWxsO1xuICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcblxuICBjbGVhcihwYXJlbnROb2RlLCBmaXJzdE5vZGUsIGxhc3ROb2RlKTtcbn07XG5cbk1vcnBoLnByb3RvdHlwZS51bmxpbmsgPSBmdW5jdGlvbiBNb3JwaCR1bmxpbmsoKSB7XG4gIHZhciBwYXJlbnRNb3JwaExpc3QgPSB0aGlzLnBhcmVudE1vcnBoTGlzdDtcbiAgdmFyIHByZXZpb3VzTW9ycGggPSB0aGlzLnByZXZpb3VzTW9ycGg7XG4gIHZhciBuZXh0TW9ycGggPSB0aGlzLm5leHRNb3JwaDtcblxuICBpZiAocHJldmlvdXNNb3JwaCkge1xuICAgIGlmIChuZXh0TW9ycGgpIHtcbiAgICAgIHByZXZpb3VzTW9ycGgubmV4dE1vcnBoID0gbmV4dE1vcnBoO1xuICAgICAgbmV4dE1vcnBoLnByZXZpb3VzTW9ycGggPSBwcmV2aW91c01vcnBoO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcmV2aW91c01vcnBoLm5leHRNb3JwaCA9IG51bGw7XG4gICAgICBwYXJlbnRNb3JwaExpc3QubGFzdENoaWxkTW9ycGggPSBwcmV2aW91c01vcnBoO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAobmV4dE1vcnBoKSB7XG4gICAgICBuZXh0TW9ycGgucHJldmlvdXNNb3JwaCA9IG51bGw7XG4gICAgICBwYXJlbnRNb3JwaExpc3QuZmlyc3RDaGlsZE1vcnBoID0gbmV4dE1vcnBoO1xuICAgIH0gZWxzZSBpZiAocGFyZW50TW9ycGhMaXN0KSB7XG4gICAgICBwYXJlbnRNb3JwaExpc3QubGFzdENoaWxkTW9ycGggPSBwYXJlbnRNb3JwaExpc3QuZmlyc3RDaGlsZE1vcnBoID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICB0aGlzLnBhcmVudE1vcnBoTGlzdCA9IG51bGw7XG4gIHRoaXMubmV4dE1vcnBoID0gbnVsbDtcbiAgdGhpcy5wcmV2aW91c01vcnBoID0gbnVsbDtcblxuICBpZiAocGFyZW50TW9ycGhMaXN0ICYmIHBhcmVudE1vcnBoTGlzdC5tb3VudGVkTW9ycGgpIHtcbiAgICBpZiAoIXBhcmVudE1vcnBoTGlzdC5maXJzdENoaWxkTW9ycGgpIHtcbiAgICAgIC8vIGxpc3QgaXMgZW1wdHlcbiAgICAgIHBhcmVudE1vcnBoTGlzdC5tb3VudGVkTW9ycGguY2xlYXIoKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50TW9ycGhMaXN0LmZpcnN0Q2hpbGRNb3JwaC5fc3luY0ZpcnN0Tm9kZSgpO1xuICAgICAgcGFyZW50TW9ycGhMaXN0Lmxhc3RDaGlsZE1vcnBoLl9zeW5jTGFzdE5vZGUoKTtcbiAgICB9XG4gIH1cbn07XG5cbk1vcnBoLnByb3RvdHlwZS5zZXRIVE1MID0gZnVuY3Rpb24odGV4dCkge1xuICB2YXIgZnJhZ21lbnQgPSB0aGlzLmRvbUhlbHBlci5wYXJzZUhUTUwodGV4dCwgdGhpcy5jb250ZXh0dWFsRWxlbWVudCk7XG4gIHJldHVybiB0aGlzLnNldE5vZGUoZnJhZ21lbnQpO1xufTtcblxuTW9ycGgucHJvdG90eXBlLnNldE1vcnBoTGlzdCA9IGZ1bmN0aW9uIE1vcnBoJGFwcGVuZE1vcnBoTGlzdChtb3JwaExpc3QpIHtcbiAgbW9ycGhMaXN0Lm1vdW50ZWRNb3JwaCA9IHRoaXM7XG4gIHRoaXMuY2xlYXIoKTtcblxuICB2YXIgb3JpZ2luYWxGaXJzdE5vZGUgPSB0aGlzLmZpcnN0Tm9kZTtcblxuICBpZiAobW9ycGhMaXN0LmZpcnN0Q2hpbGRNb3JwaCkge1xuICAgIHRoaXMuZmlyc3ROb2RlID0gbW9ycGhMaXN0LmZpcnN0Q2hpbGRNb3JwaC5maXJzdE5vZGU7XG4gICAgdGhpcy5sYXN0Tm9kZSA9IG1vcnBoTGlzdC5sYXN0Q2hpbGRNb3JwaC5sYXN0Tm9kZTtcblxuICAgIHZhciBjdXJyZW50ID0gbW9ycGhMaXN0LmZpcnN0Q2hpbGRNb3JwaDtcblxuICAgIHdoaWxlIChjdXJyZW50KSB7XG4gICAgICB2YXIgbmV4dCA9IGN1cnJlbnQubmV4dE1vcnBoO1xuICAgICAgY3VycmVudC5pbnNlcnRCZWZvcmVOb2RlKG9yaWdpbmFsRmlyc3ROb2RlLCBudWxsKTtcbiAgICAgIGN1cnJlbnQgPSBuZXh0O1xuICAgIH1cbiAgICBvcmlnaW5hbEZpcnN0Tm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG9yaWdpbmFsRmlyc3ROb2RlKTtcbiAgfVxufTtcblxuTW9ycGgucHJvdG90eXBlLl9zeW5jRmlyc3ROb2RlID0gZnVuY3Rpb24gTW9ycGgkc3luY0ZpcnN0Tm9kZSgpIHtcbiAgdmFyIG1vcnBoID0gdGhpcztcbiAgdmFyIHBhcmVudE1vcnBoTGlzdDtcbiAgd2hpbGUgKHBhcmVudE1vcnBoTGlzdCA9IG1vcnBoLnBhcmVudE1vcnBoTGlzdCkge1xuICAgIGlmIChwYXJlbnRNb3JwaExpc3QubW91bnRlZE1vcnBoID09PSBudWxsKSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKG1vcnBoICE9PSBwYXJlbnRNb3JwaExpc3QuZmlyc3RDaGlsZE1vcnBoKSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKG1vcnBoLmZpcnN0Tm9kZSA9PT0gcGFyZW50TW9ycGhMaXN0Lm1vdW50ZWRNb3JwaC5maXJzdE5vZGUpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHBhcmVudE1vcnBoTGlzdC5tb3VudGVkTW9ycGguZmlyc3ROb2RlID0gbW9ycGguZmlyc3ROb2RlO1xuXG4gICAgbW9ycGggPSBwYXJlbnRNb3JwaExpc3QubW91bnRlZE1vcnBoO1xuICB9XG59O1xuXG5Nb3JwaC5wcm90b3R5cGUuX3N5bmNMYXN0Tm9kZSA9IGZ1bmN0aW9uIE1vcnBoJHN5bmNMYXN0Tm9kZSgpIHtcbiAgdmFyIG1vcnBoID0gdGhpcztcbiAgdmFyIHBhcmVudE1vcnBoTGlzdDtcbiAgd2hpbGUgKHBhcmVudE1vcnBoTGlzdCA9IG1vcnBoLnBhcmVudE1vcnBoTGlzdCkge1xuICAgIGlmIChwYXJlbnRNb3JwaExpc3QubW91bnRlZE1vcnBoID09PSBudWxsKSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKG1vcnBoICE9PSBwYXJlbnRNb3JwaExpc3QubGFzdENoaWxkTW9ycGgpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAobW9ycGgubGFzdE5vZGUgPT09IHBhcmVudE1vcnBoTGlzdC5tb3VudGVkTW9ycGgubGFzdE5vZGUpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHBhcmVudE1vcnBoTGlzdC5tb3VudGVkTW9ycGgubGFzdE5vZGUgPSBtb3JwaC5sYXN0Tm9kZTtcblxuICAgIG1vcnBoID0gcGFyZW50TW9ycGhMaXN0Lm1vdW50ZWRNb3JwaDtcbiAgfVxufTtcblxuTW9ycGgucHJvdG90eXBlLmluc2VydEJlZm9yZU5vZGUgPSBmdW5jdGlvbiBNb3JwaCRpbnNlcnRCZWZvcmVOb2RlKHBhcmVudE5vZGUsIHJlZk5vZGUpIHtcbiAgaW5zZXJ0QmVmb3JlKHBhcmVudE5vZGUsIHRoaXMuZmlyc3ROb2RlLCB0aGlzLmxhc3ROb2RlLCByZWZOb2RlKTtcbn07XG5cbk1vcnBoLnByb3RvdHlwZS5hcHBlbmRUb05vZGUgPSBmdW5jdGlvbiBNb3JwaCRhcHBlbmRUb05vZGUocGFyZW50Tm9kZSkge1xuICBpbnNlcnRCZWZvcmUocGFyZW50Tm9kZSwgdGhpcy5maXJzdE5vZGUsIHRoaXMubGFzdE5vZGUsIG51bGwpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgTW9ycGg7XG4iXX0=