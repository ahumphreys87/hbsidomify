exports.__esModule = true;

var _htmlbarsUtilMorphUtils = require("../htmlbars-util/morph-utils");

var _expressionVisitor = require("./expression-visitor");

/**
  Node classification:

  # Primary Statement Nodes:

  These nodes are responsible for a render node that represents a morph-range.

  * block
  * inline
  * content
  * element
  * component

  # Leaf Statement Nodes:

  This node is responsible for a render node that represents a morph-attr.

  * attribute
*/

function linkParamsAndHash(env, scope, morph, path, params, hash) {
  if (morph.linkedParams) {
    params = morph.linkedParams.params;
    hash = morph.linkedParams.hash;
  } else {
    params = params && _expressionVisitor.acceptParams(params, env, scope);
    hash = hash && _expressionVisitor.acceptHash(hash, env, scope);
  }

  _htmlbarsUtilMorphUtils.linkParams(env, scope, morph, path, params, hash);
  return [params, hash];
}

var AlwaysDirtyVisitor = {

  block: function (node, morph, env, scope, template, visitor) {
    var path = node[1];
    var params = node[2];
    var hash = node[3];
    var templateId = node[4];
    var inverseId = node[5];

    var paramsAndHash = linkParamsAndHash(env, scope, morph, path, params, hash);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.block(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], templateId === null ? null : template.templates[templateId], inverseId === null ? null : template.templates[inverseId], visitor);
  },

  inline: function (node, morph, env, scope, visitor) {
    var path = node[1];
    var params = node[2];
    var hash = node[3];

    var paramsAndHash = linkParamsAndHash(env, scope, morph, path, params, hash);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.inline(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], visitor);
  },

  content: function (node, morph, env, scope, visitor) {
    var path = node[1];

    morph.isDirty = morph.isSubtreeDirty = false;

    if (isHelper(env, scope, path)) {
      env.hooks.inline(morph, env, scope, path, [], {}, visitor);
      if (morph.linkedResult) {
        _htmlbarsUtilMorphUtils.linkParams(env, scope, morph, '@content-helper', [morph.linkedResult], null);
      }
      return;
    }

    var params = undefined;
    if (morph.linkedParams) {
      params = morph.linkedParams.params;
    } else {
      params = [env.hooks.get(env, scope, path)];
    }

    _htmlbarsUtilMorphUtils.linkParams(env, scope, morph, '@range', params, null);
    env.hooks.range(morph, env, scope, path, params[0], visitor);
  },

  element: function (node, morph, env, scope, visitor) {
    var path = node[1];
    var params = node[2];
    var hash = node[3];

    var paramsAndHash = linkParamsAndHash(env, scope, morph, path, params, hash);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.element(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], visitor);
  },

  attribute: function (node, morph, env, scope) {
    var name = node[1];
    var value = node[2];

    var paramsAndHash = linkParamsAndHash(env, scope, morph, '@attribute', [value], null);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.attribute(morph, env, scope, name, paramsAndHash[0][0]);
  },

  component: function (node, morph, env, scope, template, visitor) {
    var path = node[1];
    var attrs = node[2];
    var templateId = node[3];
    var inverseId = node[4];

    var paramsAndHash = linkParamsAndHash(env, scope, morph, path, [], attrs);
    var templates = {
      default: template.templates[templateId],
      inverse: template.templates[inverseId]
    };

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.component(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], templates, visitor);
  },

  attributes: function (node, morph, env, scope, parentMorph, visitor) {
    var template = node[1];

    env.hooks.attributes(morph, env, scope, template, parentMorph, visitor);
  }

};

exports.AlwaysDirtyVisitor = AlwaysDirtyVisitor;
exports.default = {
  block: function (node, morph, env, scope, template, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.block(node, morph, env, scope, template, visitor);
    });
  },

  inline: function (node, morph, env, scope, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.inline(node, morph, env, scope, visitor);
    });
  },

  content: function (node, morph, env, scope, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.content(node, morph, env, scope, visitor);
    });
  },

  element: function (node, morph, env, scope, template, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.element(node, morph, env, scope, template, visitor);
    });
  },

  attribute: function (node, morph, env, scope, template) {
    dirtyCheck(env, morph, null, function () {
      AlwaysDirtyVisitor.attribute(node, morph, env, scope, template);
    });
  },

  component: function (node, morph, env, scope, template, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.component(node, morph, env, scope, template, visitor);
    });
  },

  attributes: function (node, morph, env, scope, parentMorph, visitor) {
    AlwaysDirtyVisitor.attributes(node, morph, env, scope, parentMorph, visitor);
  }
};

function dirtyCheck(_env, morph, visitor, callback) {
  var isDirty = morph.isDirty;
  var isSubtreeDirty = morph.isSubtreeDirty;
  var env = _env;

  if (isSubtreeDirty) {
    visitor = AlwaysDirtyVisitor;
  }

  if (isDirty || isSubtreeDirty) {
    callback(visitor);
  } else {
    if (morph.buildChildEnv) {
      env = morph.buildChildEnv(morph.getState(), env);
    }
    _htmlbarsUtilMorphUtils.validateChildMorphs(env, morph, visitor);
  }
}

function isHelper(env, scope, path) {
  return env.hooks.keywords[path] !== undefined || env.hooks.hasHelper(env, scope, path);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXJ1bnRpbWUvbm9kZS12aXNpdG9yLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O3NDQUFnRCw4QkFBOEI7O2lDQUNyQyxzQkFBc0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFzQi9ELFNBQVMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7QUFDaEUsTUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFO0FBQ3RCLFVBQU0sR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztBQUNuQyxRQUFJLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7R0FDaEMsTUFBTTtBQUNMLFVBQU0sR0FBRyxNQUFNLElBQUksZ0NBQWEsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNwRCxRQUFJLEdBQUcsSUFBSSxJQUFJLDhCQUFXLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7R0FDN0M7O0FBRUQscUNBQVcsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNsRCxTQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0NBQ3ZCOztBQUVNLElBQUksa0JBQWtCLEdBQUc7O0FBRTlCLE9BQUssRUFBQSxVQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFO1FBQ3pDLElBQUksR0FBeUMsSUFBSTtRQUEzQyxNQUFNLEdBQWlDLElBQUk7UUFBbkMsSUFBSSxHQUEyQixJQUFJO1FBQTdCLFVBQVUsR0FBZSxJQUFJO1FBQWpCLFNBQVMsR0FBSSxJQUFJOztBQUN4RCxRQUFJLGFBQWEsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDOztBQUU3RSxTQUFLLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO0FBQzdDLE9BQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUNwRCxVQUFVLEtBQUssSUFBSSxHQUFHLElBQUksR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUMzRCxTQUFTLEtBQUssSUFBSSxHQUFHLElBQUksR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUN6RCxPQUFPLENBQUMsQ0FBQztHQUNqQzs7QUFFRCxRQUFNLEVBQUEsVUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFO1FBQ2hDLElBQUksR0FBa0IsSUFBSTtRQUFwQixNQUFNLEdBQVUsSUFBSTtRQUFaLElBQUksR0FBSSxJQUFJOztBQUNqQyxRQUFJLGFBQWEsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDOztBQUU3RSxTQUFLLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO0FBQzdDLE9BQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0dBQ3hGOztBQUVELFNBQU8sRUFBQSxVQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUU7UUFDakMsSUFBSSxHQUFJLElBQUk7O0FBRW5CLFNBQUssQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7O0FBRTdDLFFBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUU7QUFDOUIsU0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0QsVUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFO0FBQ3RCLDJDQUFXLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO09BQzlFO0FBQ0QsYUFBTztLQUNSOztBQUVELFFBQUksTUFBTSxZQUFBLENBQUM7QUFDWCxRQUFJLEtBQUssQ0FBQyxZQUFZLEVBQUU7QUFDdEIsWUFBTSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO0tBQ3BDLE1BQU07QUFDTCxZQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7S0FDNUM7O0FBRUQsdUNBQVcsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN0RCxPQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0dBQzlEOztBQUVELFNBQU8sRUFBQSxVQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUU7UUFDakMsSUFBSSxHQUFrQixJQUFJO1FBQXBCLE1BQU0sR0FBVSxJQUFJO1FBQVosSUFBSSxHQUFJLElBQUk7O0FBQ2pDLFFBQUksYUFBYSxHQUFHLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7O0FBRTdFLFNBQUssQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7QUFDN0MsT0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7R0FDekY7O0FBRUQsV0FBUyxFQUFBLFVBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFO1FBQzFCLElBQUksR0FBVyxJQUFJO1FBQWIsS0FBSyxHQUFJLElBQUk7O0FBQzFCLFFBQUksYUFBYSxHQUFHLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDOztBQUV0RixTQUFLLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO0FBQzdDLE9BQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztHQUNuRTs7QUFFRCxXQUFTLEVBQUEsVUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtRQUM3QyxJQUFJLEdBQWtDLElBQUk7UUFBcEMsS0FBSyxHQUEyQixJQUFJO1FBQTdCLFVBQVUsR0FBZSxJQUFJO1FBQWpCLFNBQVMsR0FBSSxJQUFJOztBQUNqRCxRQUFJLGFBQWEsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQzFFLFFBQUksU0FBUyxHQUFHO0FBQ2QsYUFBTyxFQUFFLFFBQVEsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO0FBQ3ZDLGFBQU8sRUFBRSxRQUFRLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQztLQUN2QyxDQUFDOztBQUVGLFNBQUssQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7QUFDN0MsT0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQzNELFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztHQUN6Qzs7QUFFRCxZQUFVLEVBQUEsVUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRTtRQUNqRCxRQUFRLEdBQUksSUFBSTs7QUFDdkIsT0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztHQUN6RTs7Q0FFRixDQUFDOzs7a0JBRWE7QUFDYixPQUFLLEVBQUEsVUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtBQUNoRCxjQUFVLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsVUFBQSxPQUFPLEVBQUk7QUFDekMsd0JBQWtCLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDdEUsQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsUUFBTSxFQUFBLFVBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRTtBQUN2QyxjQUFVLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsVUFBQSxPQUFPLEVBQUk7QUFDekMsd0JBQWtCLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztLQUM3RCxDQUFDLENBQUM7R0FDSjs7QUFFRCxTQUFPLEVBQUEsVUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFO0FBQ3hDLGNBQVUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxVQUFBLE9BQU8sRUFBSTtBQUN6Qyx3QkFBa0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQzlELENBQUMsQ0FBQztHQUNKOztBQUVELFNBQU8sRUFBQSxVQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFO0FBQ2xELGNBQVUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxVQUFBLE9BQU8sRUFBSTtBQUN6Qyx3QkFBa0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztLQUN4RSxDQUFDLENBQUM7R0FDSjs7QUFFRCxXQUFTLEVBQUEsVUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFO0FBQzNDLGNBQVUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxZQUFNO0FBQ2pDLHdCQUFrQixDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDakUsQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsV0FBUyxFQUFBLFVBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUU7QUFDcEQsY0FBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFVBQUEsT0FBTyxFQUFJO0FBQ3pDLHdCQUFrQixDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQzFFLENBQUMsQ0FBQztHQUNKOztBQUVELFlBQVUsRUFBQSxVQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFO0FBQ3hELHNCQUFrQixDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0dBQzlFO0NBQ0Y7O0FBRUQsU0FBUyxVQUFVLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFO0FBQ2xELE1BQUksT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7QUFDNUIsTUFBSSxjQUFjLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQztBQUMxQyxNQUFJLEdBQUcsR0FBRyxJQUFJLENBQUM7O0FBRWYsTUFBSSxjQUFjLEVBQUU7QUFDbEIsV0FBTyxHQUFHLGtCQUFrQixDQUFDO0dBQzlCOztBQUVELE1BQUksT0FBTyxJQUFJLGNBQWMsRUFBRTtBQUM3QixZQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7R0FDbkIsTUFBTTtBQUNMLFFBQUksS0FBSyxDQUFDLGFBQWEsRUFBRTtBQUN2QixTQUFHLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7S0FDbEQ7QUFDRCxnREFBb0IsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztHQUMxQztDQUNGOztBQUVELFNBQVMsUUFBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO0FBQ2xDLFNBQU8sQUFBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLElBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztDQUMxRiIsImZpbGUiOiJodG1sYmFycy1ydW50aW1lL25vZGUtdmlzaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHZhbGlkYXRlQ2hpbGRNb3JwaHMsIGxpbmtQYXJhbXMgfSBmcm9tIFwiLi4vaHRtbGJhcnMtdXRpbC9tb3JwaC11dGlsc1wiO1xuaW1wb3J0IHsgYWNjZXB0UGFyYW1zLCBhY2NlcHRIYXNoIH0gZnJvbSBcIi4vZXhwcmVzc2lvbi12aXNpdG9yXCI7XG5cbi8qKlxuICBOb2RlIGNsYXNzaWZpY2F0aW9uOlxuXG4gICMgUHJpbWFyeSBTdGF0ZW1lbnQgTm9kZXM6XG5cbiAgVGhlc2Ugbm9kZXMgYXJlIHJlc3BvbnNpYmxlIGZvciBhIHJlbmRlciBub2RlIHRoYXQgcmVwcmVzZW50cyBhIG1vcnBoLXJhbmdlLlxuXG4gICogYmxvY2tcbiAgKiBpbmxpbmVcbiAgKiBjb250ZW50XG4gICogZWxlbWVudFxuICAqIGNvbXBvbmVudFxuXG4gICMgTGVhZiBTdGF0ZW1lbnQgTm9kZXM6XG5cbiAgVGhpcyBub2RlIGlzIHJlc3BvbnNpYmxlIGZvciBhIHJlbmRlciBub2RlIHRoYXQgcmVwcmVzZW50cyBhIG1vcnBoLWF0dHIuXG5cbiAgKiBhdHRyaWJ1dGVcbiovXG5cbmZ1bmN0aW9uIGxpbmtQYXJhbXNBbmRIYXNoKGVudiwgc2NvcGUsIG1vcnBoLCBwYXRoLCBwYXJhbXMsIGhhc2gpIHtcbiAgaWYgKG1vcnBoLmxpbmtlZFBhcmFtcykge1xuICAgIHBhcmFtcyA9IG1vcnBoLmxpbmtlZFBhcmFtcy5wYXJhbXM7XG4gICAgaGFzaCA9IG1vcnBoLmxpbmtlZFBhcmFtcy5oYXNoO1xuICB9IGVsc2Uge1xuICAgIHBhcmFtcyA9IHBhcmFtcyAmJiBhY2NlcHRQYXJhbXMocGFyYW1zLCBlbnYsIHNjb3BlKTtcbiAgICBoYXNoID0gaGFzaCAmJiBhY2NlcHRIYXNoKGhhc2gsIGVudiwgc2NvcGUpO1xuICB9XG5cbiAgbGlua1BhcmFtcyhlbnYsIHNjb3BlLCBtb3JwaCwgcGF0aCwgcGFyYW1zLCBoYXNoKTtcbiAgcmV0dXJuIFtwYXJhbXMsIGhhc2hdO1xufVxuXG5leHBvcnQgbGV0IEFsd2F5c0RpcnR5VmlzaXRvciA9IHtcblxuICBibG9jayhub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpIHtcbiAgICBsZXQgWywgcGF0aCwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZUlkLCBpbnZlcnNlSWRdID0gbm9kZTtcbiAgICBsZXQgcGFyYW1zQW5kSGFzaCA9IGxpbmtQYXJhbXNBbmRIYXNoKGVudiwgc2NvcGUsIG1vcnBoLCBwYXRoLCBwYXJhbXMsIGhhc2gpO1xuXG4gICAgbW9ycGguaXNEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG4gICAgZW52Lmhvb2tzLmJsb2NrKG1vcnBoLCBlbnYsIHNjb3BlLCBwYXRoLCBwYXJhbXNBbmRIYXNoWzBdLCBwYXJhbXNBbmRIYXNoWzFdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVJZCA9PT0gbnVsbCA/IG51bGwgOiB0ZW1wbGF0ZS50ZW1wbGF0ZXNbdGVtcGxhdGVJZF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZlcnNlSWQgPT09IG51bGwgPyBudWxsIDogdGVtcGxhdGUudGVtcGxhdGVzW2ludmVyc2VJZF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB2aXNpdG9yKTtcbiAgfSxcblxuICBpbmxpbmUobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICBsZXQgWywgcGF0aCwgcGFyYW1zLCBoYXNoXSA9IG5vZGU7XG4gICAgbGV0IHBhcmFtc0FuZEhhc2ggPSBsaW5rUGFyYW1zQW5kSGFzaChlbnYsIHNjb3BlLCBtb3JwaCwgcGF0aCwgcGFyYW1zLCBoYXNoKTtcblxuICAgIG1vcnBoLmlzRGlydHkgPSBtb3JwaC5pc1N1YnRyZWVEaXJ0eSA9IGZhbHNlO1xuICAgIGVudi5ob29rcy5pbmxpbmUobW9ycGgsIGVudiwgc2NvcGUsIHBhdGgsIHBhcmFtc0FuZEhhc2hbMF0sIHBhcmFtc0FuZEhhc2hbMV0sIHZpc2l0b3IpO1xuICB9LFxuXG4gIGNvbnRlbnQobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICBsZXQgWywgcGF0aF0gPSBub2RlO1xuXG4gICAgbW9ycGguaXNEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG5cbiAgICBpZiAoaXNIZWxwZXIoZW52LCBzY29wZSwgcGF0aCkpIHtcbiAgICAgIGVudi5ob29rcy5pbmxpbmUobW9ycGgsIGVudiwgc2NvcGUsIHBhdGgsIFtdLCB7fSwgdmlzaXRvcik7XG4gICAgICBpZiAobW9ycGgubGlua2VkUmVzdWx0KSB7XG4gICAgICAgIGxpbmtQYXJhbXMoZW52LCBzY29wZSwgbW9ycGgsICdAY29udGVudC1oZWxwZXInLCBbbW9ycGgubGlua2VkUmVzdWx0XSwgbnVsbCk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IHBhcmFtcztcbiAgICBpZiAobW9ycGgubGlua2VkUGFyYW1zKSB7XG4gICAgICBwYXJhbXMgPSBtb3JwaC5saW5rZWRQYXJhbXMucGFyYW1zO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBbZW52Lmhvb2tzLmdldChlbnYsIHNjb3BlLCBwYXRoKV07XG4gICAgfVxuXG4gICAgbGlua1BhcmFtcyhlbnYsIHNjb3BlLCBtb3JwaCwgJ0ByYW5nZScsIHBhcmFtcywgbnVsbCk7XG4gICAgZW52Lmhvb2tzLnJhbmdlKG1vcnBoLCBlbnYsIHNjb3BlLCBwYXRoLCBwYXJhbXNbMF0sIHZpc2l0b3IpO1xuICB9LFxuXG4gIGVsZW1lbnQobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICBsZXQgWywgcGF0aCwgcGFyYW1zLCBoYXNoXSA9IG5vZGU7XG4gICAgbGV0IHBhcmFtc0FuZEhhc2ggPSBsaW5rUGFyYW1zQW5kSGFzaChlbnYsIHNjb3BlLCBtb3JwaCwgcGF0aCwgcGFyYW1zLCBoYXNoKTtcblxuICAgIG1vcnBoLmlzRGlydHkgPSBtb3JwaC5pc1N1YnRyZWVEaXJ0eSA9IGZhbHNlO1xuICAgIGVudi5ob29rcy5lbGVtZW50KG1vcnBoLCBlbnYsIHNjb3BlLCBwYXRoLCBwYXJhbXNBbmRIYXNoWzBdLCBwYXJhbXNBbmRIYXNoWzFdLCB2aXNpdG9yKTtcbiAgfSxcblxuICBhdHRyaWJ1dGUobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUpIHtcbiAgICBsZXQgWywgbmFtZSwgdmFsdWVdID0gbm9kZTtcbiAgICBsZXQgcGFyYW1zQW5kSGFzaCA9IGxpbmtQYXJhbXNBbmRIYXNoKGVudiwgc2NvcGUsIG1vcnBoLCAnQGF0dHJpYnV0ZScsIFt2YWx1ZV0sIG51bGwpO1xuXG4gICAgbW9ycGguaXNEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG4gICAgZW52Lmhvb2tzLmF0dHJpYnV0ZShtb3JwaCwgZW52LCBzY29wZSwgbmFtZSwgcGFyYW1zQW5kSGFzaFswXVswXSk7XG4gIH0sXG5cbiAgY29tcG9uZW50KG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcikge1xuICAgIGxldCBbLCBwYXRoLCBhdHRycywgdGVtcGxhdGVJZCwgaW52ZXJzZUlkXSA9IG5vZGU7XG4gICAgbGV0IHBhcmFtc0FuZEhhc2ggPSBsaW5rUGFyYW1zQW5kSGFzaChlbnYsIHNjb3BlLCBtb3JwaCwgcGF0aCwgW10sIGF0dHJzKTtcbiAgICBsZXQgdGVtcGxhdGVzID0ge1xuICAgICAgZGVmYXVsdDogdGVtcGxhdGUudGVtcGxhdGVzW3RlbXBsYXRlSWRdLFxuICAgICAgaW52ZXJzZTogdGVtcGxhdGUudGVtcGxhdGVzW2ludmVyc2VJZF1cbiAgICB9O1xuXG4gICAgbW9ycGguaXNEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG4gICAgZW52Lmhvb2tzLmNvbXBvbmVudChtb3JwaCwgZW52LCBzY29wZSwgcGF0aCwgcGFyYW1zQW5kSGFzaFswXSwgcGFyYW1zQW5kSGFzaFsxXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlcywgdmlzaXRvcik7XG4gIH0sXG5cbiAgYXR0cmlidXRlcyhub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgcGFyZW50TW9ycGgsIHZpc2l0b3IpIHtcbiAgICBsZXQgWywgdGVtcGxhdGVdID0gbm9kZTtcbiAgICBlbnYuaG9va3MuYXR0cmlidXRlcyhtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHBhcmVudE1vcnBoLCB2aXNpdG9yKTtcbiAgfVxuXG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGJsb2NrKG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcikge1xuICAgIGRpcnR5Q2hlY2soZW52LCBtb3JwaCwgdmlzaXRvciwgdmlzaXRvciA9PiB7XG4gICAgICBBbHdheXNEaXJ0eVZpc2l0b3IuYmxvY2sobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlLCB2aXNpdG9yKTtcbiAgICB9KTtcbiAgfSxcblxuICBpbmxpbmUobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIHZpc2l0b3IsIHZpc2l0b3IgPT4ge1xuICAgICAgQWx3YXlzRGlydHlWaXNpdG9yLmlubGluZShub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdmlzaXRvcik7XG4gICAgfSk7XG4gIH0sXG5cbiAgY29udGVudChub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdmlzaXRvcikge1xuICAgIGRpcnR5Q2hlY2soZW52LCBtb3JwaCwgdmlzaXRvciwgdmlzaXRvciA9PiB7XG4gICAgICBBbHdheXNEaXJ0eVZpc2l0b3IuY29udGVudChub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdmlzaXRvcik7XG4gICAgfSk7XG4gIH0sXG5cbiAgZWxlbWVudChub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIHZpc2l0b3IsIHZpc2l0b3IgPT4ge1xuICAgICAgQWx3YXlzRGlydHlWaXNpdG9yLmVsZW1lbnQobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlLCB2aXNpdG9yKTtcbiAgICB9KTtcbiAgfSxcblxuICBhdHRyaWJ1dGUobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlKSB7XG4gICAgZGlydHlDaGVjayhlbnYsIG1vcnBoLCBudWxsLCAoKSA9PiB7XG4gICAgICBBbHdheXNEaXJ0eVZpc2l0b3IuYXR0cmlidXRlKG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgY29tcG9uZW50KG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcikge1xuICAgIGRpcnR5Q2hlY2soZW52LCBtb3JwaCwgdmlzaXRvciwgdmlzaXRvciA9PiB7XG4gICAgICBBbHdheXNEaXJ0eVZpc2l0b3IuY29tcG9uZW50KG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcik7XG4gICAgfSk7XG4gIH0sXG5cbiAgYXR0cmlidXRlcyhub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgcGFyZW50TW9ycGgsIHZpc2l0b3IpIHtcbiAgICBBbHdheXNEaXJ0eVZpc2l0b3IuYXR0cmlidXRlcyhub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgcGFyZW50TW9ycGgsIHZpc2l0b3IpO1xuICB9XG59O1xuXG5mdW5jdGlvbiBkaXJ0eUNoZWNrKF9lbnYsIG1vcnBoLCB2aXNpdG9yLCBjYWxsYmFjaykge1xuICB2YXIgaXNEaXJ0eSA9IG1vcnBoLmlzRGlydHk7XG4gIHZhciBpc1N1YnRyZWVEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5O1xuICB2YXIgZW52ID0gX2VudjtcblxuICBpZiAoaXNTdWJ0cmVlRGlydHkpIHtcbiAgICB2aXNpdG9yID0gQWx3YXlzRGlydHlWaXNpdG9yO1xuICB9XG5cbiAgaWYgKGlzRGlydHkgfHwgaXNTdWJ0cmVlRGlydHkpIHtcbiAgICBjYWxsYmFjayh2aXNpdG9yKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAobW9ycGguYnVpbGRDaGlsZEVudikge1xuICAgICAgZW52ID0gbW9ycGguYnVpbGRDaGlsZEVudihtb3JwaC5nZXRTdGF0ZSgpLCBlbnYpO1xuICAgIH1cbiAgICB2YWxpZGF0ZUNoaWxkTW9ycGhzKGVudiwgbW9ycGgsIHZpc2l0b3IpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzSGVscGVyKGVudiwgc2NvcGUsIHBhdGgpIHtcbiAgcmV0dXJuIChlbnYuaG9va3Mua2V5d29yZHNbcGF0aF0gIT09IHVuZGVmaW5lZCkgfHwgZW52Lmhvb2tzLmhhc0hlbHBlcihlbnYsIHNjb3BlLCBwYXRoKTtcbn1cbiJdfQ==