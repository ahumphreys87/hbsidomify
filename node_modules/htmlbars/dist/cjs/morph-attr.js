exports.__esModule = true;

var _morphAttrSanitizeAttributeValue = require("./morph-attr/sanitize-attribute-value");

var _domHelperProp = require("./dom-helper/prop");

var _domHelperBuildHtmlDom = require("./dom-helper/build-html-dom");

var _htmlbarsUtil = require("./htmlbars-util");

function getProperty() {
  return this.domHelper.getPropertyStrict(this.element, this.attrName);
}

function updateProperty(value) {
  if (this._renderedInitially === true || !_domHelperProp.isAttrRemovalValue(value)) {
    // do not render if initial value is undefined or null
    this.domHelper.setPropertyStrict(this.element, this.attrName, value);
  }

  this._renderedInitially = true;
}

function getAttribute() {
  return this.domHelper.getAttribute(this.element, this.attrName);
}

function updateAttribute(value) {
  if (_domHelperProp.isAttrRemovalValue(value)) {
    this.domHelper.removeAttribute(this.element, this.attrName);
  } else {
    this.domHelper.setAttribute(this.element, this.attrName, value);
  }
}

function getAttributeNS() {
  return this.domHelper.getAttributeNS(this.element, this.namespace, this.attrName);
}

function updateAttributeNS(value) {
  if (_domHelperProp.isAttrRemovalValue(value)) {
    this.domHelper.removeAttribute(this.element, this.attrName);
  } else {
    this.domHelper.setAttributeNS(this.element, this.namespace, this.attrName, value);
  }
}

var UNSET = { unset: true };

var guid = 1;

AttrMorph.create = function (element, attrName, domHelper, namespace) {
  var ns = _htmlbarsUtil.getAttrNamespace(attrName, namespace);

  if (ns) {
    return new AttributeNSAttrMorph(element, attrName, domHelper, ns);
  } else {
    return createNonNamespacedAttrMorph(element, attrName, domHelper);
  }
};

function createNonNamespacedAttrMorph(element, attrName, domHelper) {
  var _normalizeProperty = _domHelperProp.normalizeProperty(element, attrName);

  var normalized = _normalizeProperty.normalized;
  var type = _normalizeProperty.type;

  if (element.namespaceURI === _domHelperBuildHtmlDom.svgNamespace || attrName === 'style' || type === 'attr') {
    return new AttributeAttrMorph(element, normalized, domHelper);
  } else {
    return new PropertyAttrMorph(element, normalized, domHelper);
  }
}

function AttrMorph(element, attrName, domHelper) {
  this.element = element;
  this.domHelper = domHelper;
  this.attrName = attrName;
  this._state = undefined;
  this.isDirty = false;
  this.isSubtreeDirty = false;
  this.escaped = true;
  this.lastValue = UNSET;
  this.lastResult = null;
  this.lastYielded = null;
  this.childNodes = null;
  this.linkedParams = null;
  this.linkedResult = null;
  this.guid = "attr" + guid++;
  this.seen = false;
  this.ownerNode = null;
  this.rendered = false;
  this._renderedInitially = false;
  this.namespace = undefined;
  this.didInit();
}

AttrMorph.prototype.getState = function () {
  if (!this._state) {
    this._state = {};
  }

  return this._state;
};

AttrMorph.prototype.setState = function (newState) {
  /*jshint -W093 */

  return this._state = newState;
};

AttrMorph.prototype.didInit = function () {};
AttrMorph.prototype.willSetContent = function () {};

AttrMorph.prototype.setContent = function (value) {
  this.willSetContent(value);

  if (this.lastValue === value) {
    return;
  }
  this.lastValue = value;

  if (this.escaped) {
    var sanitized = _morphAttrSanitizeAttributeValue.sanitizeAttributeValue(this.domHelper, this.element, this.attrName, value);
    this._update(sanitized, this.namespace);
  } else {
    this._update(value, this.namespace);
  }
};

AttrMorph.prototype.getContent = function () {
  var value = this.lastValue = this._get();
  return value;
};

// renderAndCleanup calls `clear` on all items in the morph map
// just before calling `destroy` on the morph.
//
// As a future refactor this could be changed to set the property
// back to its original/default value.
AttrMorph.prototype.clear = function () {};

AttrMorph.prototype.destroy = function () {
  this.element = null;
  this.domHelper = null;
};

AttrMorph.prototype._$superAttrMorph = AttrMorph;

function PropertyAttrMorph(element, attrName, domHelper) {
  this._$superAttrMorph(element, attrName, domHelper);
}

PropertyAttrMorph.prototype = Object.create(AttrMorph.prototype);
PropertyAttrMorph.prototype._update = updateProperty;
PropertyAttrMorph.prototype._get = getProperty;

function AttributeNSAttrMorph(element, attrName, domHelper, namespace) {
  this._$superAttrMorph(element, attrName, domHelper);
  this.namespace = namespace;
}

AttributeNSAttrMorph.prototype = Object.create(AttrMorph.prototype);
AttributeNSAttrMorph.prototype._update = updateAttributeNS;
AttributeNSAttrMorph.prototype._get = getAttributeNS;

function AttributeAttrMorph(element, attrName, domHelper) {
  this._$superAttrMorph(element, attrName, domHelper);
}

AttributeAttrMorph.prototype = Object.create(AttrMorph.prototype);
AttributeAttrMorph.prototype._update = updateAttribute;
AttributeAttrMorph.prototype._get = getAttribute;

exports.default = AttrMorph;
exports.sanitizeAttributeValue = _morphAttrSanitizeAttributeValue.sanitizeAttributeValue;
//# sourceMappingURL=data:application/json;base64,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QyxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3BFLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUM7QUFDM0Qsb0JBQW9CLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxjQUFjLENBQUM7O0FBRXJELFNBQVMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUU7QUFDeEQsTUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7Q0FDckQ7O0FBRUQsa0JBQWtCLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2xFLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsZUFBZSxDQUFDO0FBQ3ZELGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDOztrQkFFbEMsU0FBUztRQUVmLHNCQUFzQiIsImZpbGUiOiJtb3JwaC1hdHRyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2FuaXRpemVBdHRyaWJ1dGVWYWx1ZSB9IGZyb20gXCIuL21vcnBoLWF0dHIvc2FuaXRpemUtYXR0cmlidXRlLXZhbHVlXCI7XG5pbXBvcnQgeyBpc0F0dHJSZW1vdmFsVmFsdWUsIG5vcm1hbGl6ZVByb3BlcnR5IH0gZnJvbSBcIi4vZG9tLWhlbHBlci9wcm9wXCI7XG5pbXBvcnQgeyBzdmdOYW1lc3BhY2UgfSBmcm9tIFwiLi9kb20taGVscGVyL2J1aWxkLWh0bWwtZG9tXCI7XG5pbXBvcnQgeyBnZXRBdHRyTmFtZXNwYWNlIH0gZnJvbSBcIi4vaHRtbGJhcnMtdXRpbFwiO1xuXG5mdW5jdGlvbiBnZXRQcm9wZXJ0eSgpIHtcbiAgcmV0dXJuIHRoaXMuZG9tSGVscGVyLmdldFByb3BlcnR5U3RyaWN0KHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVByb3BlcnR5KHZhbHVlKSB7XG4gIGlmICh0aGlzLl9yZW5kZXJlZEluaXRpYWxseSA9PT0gdHJ1ZSB8fCAhaXNBdHRyUmVtb3ZhbFZhbHVlKHZhbHVlKSkge1xuICAgIC8vIGRvIG5vdCByZW5kZXIgaWYgaW5pdGlhbCB2YWx1ZSBpcyB1bmRlZmluZWQgb3IgbnVsbFxuICAgIHRoaXMuZG9tSGVscGVyLnNldFByb3BlcnR5U3RyaWN0KHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSwgdmFsdWUpO1xuICB9XG5cbiAgdGhpcy5fcmVuZGVyZWRJbml0aWFsbHkgPSB0cnVlO1xufVxuXG5mdW5jdGlvbiBnZXRBdHRyaWJ1dGUoKSB7XG4gIHJldHVybiB0aGlzLmRvbUhlbHBlci5nZXRBdHRyaWJ1dGUodGhpcy5lbGVtZW50LCB0aGlzLmF0dHJOYW1lKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlQXR0cmlidXRlKHZhbHVlKSB7XG4gIGlmIChpc0F0dHJSZW1vdmFsVmFsdWUodmFsdWUpKSB7XG4gICAgdGhpcy5kb21IZWxwZXIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSk7XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5kb21IZWxwZXIuc2V0QXR0cmlidXRlKHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSwgdmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEF0dHJpYnV0ZU5TKCkge1xuICByZXR1cm4gdGhpcy5kb21IZWxwZXIuZ2V0QXR0cmlidXRlTlModGhpcy5lbGVtZW50LCB0aGlzLm5hbWVzcGFjZSwgdGhpcy5hdHRyTmFtZSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUF0dHJpYnV0ZU5TKHZhbHVlKSB7XG4gIGlmIChpc0F0dHJSZW1vdmFsVmFsdWUodmFsdWUpKSB7XG4gICAgdGhpcy5kb21IZWxwZXIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSk7XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5kb21IZWxwZXIuc2V0QXR0cmlidXRlTlModGhpcy5lbGVtZW50LCB0aGlzLm5hbWVzcGFjZSwgdGhpcy5hdHRyTmFtZSwgdmFsdWUpO1xuICB9XG59XG5cbnZhciBVTlNFVCA9IHsgdW5zZXQ6IHRydWUgfTtcblxudmFyIGd1aWQgPSAxO1xuXG5BdHRyTW9ycGguY3JlYXRlID0gZnVuY3Rpb24oZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlciwgbmFtZXNwYWNlKSB7XG4gIGxldCBucyA9IGdldEF0dHJOYW1lc3BhY2UoYXR0ck5hbWUsIG5hbWVzcGFjZSk7XG5cbiAgaWYgKG5zKSB7XG4gICAgcmV0dXJuIG5ldyBBdHRyaWJ1dGVOU0F0dHJNb3JwaChlbGVtZW50LCBhdHRyTmFtZSwgZG9tSGVscGVyLCBucyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGNyZWF0ZU5vbk5hbWVzcGFjZWRBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlcik7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGNyZWF0ZU5vbk5hbWVzcGFjZWRBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlcikge1xuICBsZXQgeyBub3JtYWxpemVkLCB0eXBlIH0gPSBub3JtYWxpemVQcm9wZXJ0eShlbGVtZW50LCBhdHRyTmFtZSk7XG5cbiAgaWYgKGVsZW1lbnQubmFtZXNwYWNlVVJJID09PSBzdmdOYW1lc3BhY2UgfHwgYXR0ck5hbWUgPT09ICdzdHlsZScgfHwgdHlwZSA9PT0gJ2F0dHInKSB7XG4gICAgcmV0dXJuIG5ldyBBdHRyaWJ1dGVBdHRyTW9ycGgoZWxlbWVudCwgbm9ybWFsaXplZCwgZG9tSGVscGVyKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV3IFByb3BlcnR5QXR0ck1vcnBoKGVsZW1lbnQsIG5vcm1hbGl6ZWQsIGRvbUhlbHBlcik7XG4gIH1cbn1cblxuZnVuY3Rpb24gQXR0ck1vcnBoKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIpIHtcbiAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDtcbiAgdGhpcy5kb21IZWxwZXIgPSBkb21IZWxwZXI7XG4gIHRoaXMuYXR0ck5hbWUgPSBhdHRyTmFtZTtcbiAgdGhpcy5fc3RhdGUgPSB1bmRlZmluZWQ7XG4gIHRoaXMuaXNEaXJ0eSA9IGZhbHNlO1xuICB0aGlzLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG4gIHRoaXMuZXNjYXBlZCA9IHRydWU7XG4gIHRoaXMubGFzdFZhbHVlID0gVU5TRVQ7XG4gIHRoaXMubGFzdFJlc3VsdCA9IG51bGw7XG4gIHRoaXMubGFzdFlpZWxkZWQgPSBudWxsO1xuICB0aGlzLmNoaWxkTm9kZXMgPSBudWxsO1xuICB0aGlzLmxpbmtlZFBhcmFtcyA9IG51bGw7XG4gIHRoaXMubGlua2VkUmVzdWx0ID0gbnVsbDtcbiAgdGhpcy5ndWlkID0gXCJhdHRyXCIgKyBndWlkKys7XG4gIHRoaXMuc2VlbiA9IGZhbHNlO1xuICB0aGlzLm93bmVyTm9kZSA9IG51bGw7XG4gIHRoaXMucmVuZGVyZWQgPSBmYWxzZTtcbiAgdGhpcy5fcmVuZGVyZWRJbml0aWFsbHkgPSBmYWxzZTtcbiAgdGhpcy5uYW1lc3BhY2UgPSB1bmRlZmluZWQ7XG4gIHRoaXMuZGlkSW5pdCgpO1xufVxuXG5BdHRyTW9ycGgucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24oKSB7XG4gIGlmICghdGhpcy5fc3RhdGUpIHtcbiAgICB0aGlzLl9zdGF0ZSA9IHt9O1xuICB9XG5cbiAgcmV0dXJuIHRoaXMuX3N0YXRlO1xufTtcblxuQXR0ck1vcnBoLnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uKG5ld1N0YXRlKSB7XG4gIC8qanNoaW50IC1XMDkzICovXG5cbiAgcmV0dXJuIHRoaXMuX3N0YXRlID0gbmV3U3RhdGU7XG59O1xuXG5BdHRyTW9ycGgucHJvdG90eXBlLmRpZEluaXQgPSBmdW5jdGlvbigpIHt9O1xuQXR0ck1vcnBoLnByb3RvdHlwZS53aWxsU2V0Q29udGVudCA9IGZ1bmN0aW9uKCkge307XG5cbkF0dHJNb3JwaC5wcm90b3R5cGUuc2V0Q29udGVudCA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICB0aGlzLndpbGxTZXRDb250ZW50KHZhbHVlKTtcblxuICBpZiAodGhpcy5sYXN0VmFsdWUgPT09IHZhbHVlKSB7IHJldHVybjsgfVxuICB0aGlzLmxhc3RWYWx1ZSA9IHZhbHVlO1xuXG4gIGlmICh0aGlzLmVzY2FwZWQpIHtcbiAgICB2YXIgc2FuaXRpemVkID0gc2FuaXRpemVBdHRyaWJ1dGVWYWx1ZSh0aGlzLmRvbUhlbHBlciwgdGhpcy5lbGVtZW50LCB0aGlzLmF0dHJOYW1lLCB2YWx1ZSk7XG4gICAgdGhpcy5fdXBkYXRlKHNhbml0aXplZCwgdGhpcy5uYW1lc3BhY2UpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMuX3VwZGF0ZSh2YWx1ZSwgdGhpcy5uYW1lc3BhY2UpO1xuICB9XG59O1xuXG5BdHRyTW9ycGgucHJvdG90eXBlLmdldENvbnRlbnQgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciB2YWx1ZSA9IHRoaXMubGFzdFZhbHVlID0gdGhpcy5fZ2V0KCk7XG4gIHJldHVybiB2YWx1ZTtcbn07XG5cbi8vIHJlbmRlckFuZENsZWFudXAgY2FsbHMgYGNsZWFyYCBvbiBhbGwgaXRlbXMgaW4gdGhlIG1vcnBoIG1hcFxuLy8ganVzdCBiZWZvcmUgY2FsbGluZyBgZGVzdHJveWAgb24gdGhlIG1vcnBoLlxuLy9cbi8vIEFzIGEgZnV0dXJlIHJlZmFjdG9yIHRoaXMgY291bGQgYmUgY2hhbmdlZCB0byBzZXQgdGhlIHByb3BlcnR5XG4vLyBiYWNrIHRvIGl0cyBvcmlnaW5hbC9kZWZhdWx0IHZhbHVlLlxuQXR0ck1vcnBoLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgeyB9O1xuXG5BdHRyTW9ycGgucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5lbGVtZW50ID0gbnVsbDtcbiAgdGhpcy5kb21IZWxwZXIgPSBudWxsO1xufTtcblxuQXR0ck1vcnBoLnByb3RvdHlwZS5fJHN1cGVyQXR0ck1vcnBoID0gQXR0ck1vcnBoO1xuXG5mdW5jdGlvbiBQcm9wZXJ0eUF0dHJNb3JwaChlbGVtZW50LCBhdHRyTmFtZSwgZG9tSGVscGVyKSB7XG4gIHRoaXMuXyRzdXBlckF0dHJNb3JwaChlbGVtZW50LCBhdHRyTmFtZSwgZG9tSGVscGVyKTtcbn1cblxuUHJvcGVydHlBdHRyTW9ycGgucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBdHRyTW9ycGgucHJvdG90eXBlKTtcblByb3BlcnR5QXR0ck1vcnBoLnByb3RvdHlwZS5fdXBkYXRlID0gdXBkYXRlUHJvcGVydHk7XG5Qcm9wZXJ0eUF0dHJNb3JwaC5wcm90b3R5cGUuX2dldCA9IGdldFByb3BlcnR5O1xuXG5mdW5jdGlvbiBBdHRyaWJ1dGVOU0F0dHJNb3JwaChlbGVtZW50LCBhdHRyTmFtZSwgZG9tSGVscGVyLCBuYW1lc3BhY2UpIHtcbiAgdGhpcy5fJHN1cGVyQXR0ck1vcnBoKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIpO1xuICB0aGlzLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTtcbn1cblxuQXR0cmlidXRlTlNBdHRyTW9ycGgucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBdHRyTW9ycGgucHJvdG90eXBlKTtcbkF0dHJpYnV0ZU5TQXR0ck1vcnBoLnByb3RvdHlwZS5fdXBkYXRlID0gdXBkYXRlQXR0cmlidXRlTlM7XG5BdHRyaWJ1dGVOU0F0dHJNb3JwaC5wcm90b3R5cGUuX2dldCA9IGdldEF0dHJpYnV0ZU5TO1xuXG5mdW5jdGlvbiBBdHRyaWJ1dGVBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlcikge1xuICB0aGlzLl8kc3VwZXJBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlcik7XG59XG5cbkF0dHJpYnV0ZUF0dHJNb3JwaC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEF0dHJNb3JwaC5wcm90b3R5cGUpO1xuQXR0cmlidXRlQXR0ck1vcnBoLnByb3RvdHlwZS5fdXBkYXRlID0gdXBkYXRlQXR0cmlidXRlO1xuQXR0cmlidXRlQXR0ck1vcnBoLnByb3RvdHlwZS5fZ2V0ID0gZ2V0QXR0cmlidXRlO1xuXG5leHBvcnQgZGVmYXVsdCBBdHRyTW9ycGg7XG5cbmV4cG9ydCB7IHNhbml0aXplQXR0cmlidXRlVmFsdWUgfTtcbiJdfQ==