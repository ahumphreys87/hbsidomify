exports.__esModule = true;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _builders = require("../builders");

var _builders2 = _interopRequireDefault(_builders);

var _utils = require("../utils");

exports.default = {

  Program: function (program) {
    var body = [];
    var node = _builders2.default.program(body, program.blockParams, program.loc);
    var i,
        l = program.body.length;

    this.elementStack.push(node);

    if (l === 0) {
      return this.elementStack.pop();
    }

    for (i = 0; i < l; i++) {
      this.acceptNode(program.body[i]);
    }

    // Ensure that that the element stack is balanced properly.
    var poppedNode = this.elementStack.pop();
    if (poppedNode !== node) {
      throw new Error("Unclosed element `" + poppedNode.tag + "` (on line " + poppedNode.loc.start.line + ").");
    }

    return node;
  },

  BlockStatement: function (block) {
    delete block.inverseStrip;
    delete block.openString;
    delete block.closeStrip;

    if (this.tokenizer.state === 'comment') {
      this.appendToCommentData('{{' + this.sourceForMustache(block) + '}}');
      return;
    }

    if (this.tokenizer.state !== 'comment' && this.tokenizer.state !== 'data' && this.tokenizer.state !== 'beforeData') {
      throw new Error("A block may only be used inside an HTML element or another block.");
    }

    block = acceptCommonNodes(this, block);
    var program = block.program ? this.acceptNode(block.program) : null;
    var inverse = block.inverse ? this.acceptNode(block.inverse) : null;

    var node = _builders2.default.block(block.path, block.params, block.hash, program, inverse, block.loc);
    var parentProgram = this.currentElement();
    _utils.appendChild(parentProgram, node);
  },

  MustacheStatement: function (rawMustache) {
    var tokenizer = this.tokenizer;
    var path = rawMustache.path;
    var params = rawMustache.params;
    var hash = rawMustache.hash;
    var escaped = rawMustache.escaped;
    var loc = rawMustache.loc;

    var mustache = _builders2.default.mustache(path, params, hash, !escaped, loc);

    if (tokenizer.state === 'comment') {
      this.appendToCommentData('{{' + this.sourceForMustache(mustache) + '}}');
      return;
    }

    acceptCommonNodes(this, mustache);

    switch (tokenizer.state) {
      // Tag helpers
      case "tagName":
        addElementModifier(this.currentNode, mustache);
        tokenizer.state = "beforeAttributeName";
        break;
      case "beforeAttributeName":
        addElementModifier(this.currentNode, mustache);
        break;
      case "attributeName":
      case "afterAttributeName":
        this.beginAttributeValue(false);
        this.finishAttributeValue();
        addElementModifier(this.currentNode, mustache);
        tokenizer.state = "beforeAttributeName";
        break;
      case "afterAttributeValueQuoted":
        addElementModifier(this.currentNode, mustache);
        tokenizer.state = "beforeAttributeName";
        break;

      // Attribute values
      case "beforeAttributeValue":
        appendDynamicAttributeValuePart(this.currentAttribute, mustache);
        tokenizer.state = 'attributeValueUnquoted';
        break;
      case "attributeValueDoubleQuoted":
      case "attributeValueSingleQuoted":
      case "attributeValueUnquoted":
        appendDynamicAttributeValuePart(this.currentAttribute, mustache);
        break;

      // TODO: Only append child when the tokenizer state makes
      // sense to do so, otherwise throw an error.
      default:
        _utils.appendChild(this.currentElement(), mustache);
    }

    return mustache;
  },

  ContentStatement: function (content) {
    var changeLines = 0;
    if (content.rightStripped) {
      changeLines = leadingNewlineDifference(content.original, content.value);
    }

    this.tokenizer.line = this.tokenizer.line + changeLines;
    this.tokenizer.tokenizePart(content.value);
    this.tokenizer.flushData();
  },

  CommentStatement: function (comment) {
    return comment;
  },

  PartialStatement: function (partial) {
    _utils.appendChild(this.currentElement(), partial);
    return partial;
  },

  SubExpression: function (sexpr) {
    return acceptCommonNodes(this, sexpr);
  },

  PathExpression: function (path) {
    delete path.data;
    delete path.depth;

    return path;
  },

  Hash: function (hash) {
    for (var i = 0; i < hash.pairs.length; i++) {
      this.acceptNode(hash.pairs[i].value);
    }

    return hash;
  },

  StringLiteral: function () {},
  BooleanLiteral: function () {},
  NumberLiteral: function () {},
  UndefinedLiteral: function () {},
  NullLiteral: function () {}
};

function leadingNewlineDifference(original, value) {
  if (value === '') {
    // if it is empty, just return the count of newlines
    // in original
    return original.split("\n").length - 1;
  }

  // otherwise, return the number of newlines prior to
  // `value`
  var difference = original.split(value)[0];
  var lines = difference.split(/\n/);

  return lines.length - 1;
}

function acceptCommonNodes(compiler, node) {
  compiler.acceptNode(node.path);

  if (node.params) {
    for (var i = 0; i < node.params.length; i++) {
      compiler.acceptNode(node.params[i]);
    }
  } else {
    node.params = [];
  }

  if (node.hash) {
    compiler.acceptNode(node.hash);
  } else {
    node.hash = _builders2.default.hash();
  }

  return node;
}

function addElementModifier(element, mustache) {
  var path = mustache.path;
  var params = mustache.params;
  var hash = mustache.hash;
  var loc = mustache.loc;

  var modifier = _builders2.default.elementModifier(path, params, hash, loc);
  element.modifiers.push(modifier);
}

function appendDynamicAttributeValuePart(attribute, part) {
  attribute.isDynamic = true;
  attribute.parts.push(part);
}
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXN5bnRheC9wYXJzZXIvaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7d0JBQWMsYUFBYTs7OztxQkFDQyxVQUFVOztrQkFFdkI7O0FBRWIsU0FBTyxFQUFFLFVBQVMsT0FBTyxFQUFFO0FBQ3pCLFFBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUNkLFFBQUksSUFBSSxHQUFHLG1CQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDN0QsUUFBSSxDQUFDO1FBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDOztBQUUvQixRQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFN0IsUUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQUUsYUFBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQUU7O0FBRWhELFNBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3RCLFVBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2xDOzs7QUFHRCxRQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3pDLFFBQUksVUFBVSxLQUFLLElBQUksRUFBRTtBQUN2QixZQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixHQUFHLFVBQVUsQ0FBQyxHQUFHLEdBQUcsYUFBYSxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQztLQUMzRzs7QUFFRCxXQUFPLElBQUksQ0FBQztHQUNiOztBQUVELGdCQUFjLEVBQUUsVUFBUyxLQUFLLEVBQUU7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QUFHLG1CQUFFLGVBQWUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztBQUMxRCxTQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztDQUNsQzs7QUFFRCxTQUFTLCtCQUErQixDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUU7QUFDeEQsV0FBUyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDM0IsV0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Q0FDNUIiLCJmaWxlIjoiaHRtbGJhcnMtc3ludGF4L3BhcnNlci9oYW5kbGViYXJzLW5vZGUtdmlzaXRvcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYiBmcm9tIFwiLi4vYnVpbGRlcnNcIjtcbmltcG9ydCB7IGFwcGVuZENoaWxkIH0gZnJvbSBcIi4uL3V0aWxzXCI7XG5cbmV4cG9ydCBkZWZhdWx0IHtcblxuICBQcm9ncmFtOiBmdW5jdGlvbihwcm9ncmFtKSB7XG4gICAgdmFyIGJvZHkgPSBbXTtcbiAgICB2YXIgbm9kZSA9IGIucHJvZ3JhbShib2R5LCBwcm9ncmFtLmJsb2NrUGFyYW1zLCBwcm9ncmFtLmxvYyk7XG4gICAgdmFyIGksIGwgPSBwcm9ncmFtLmJvZHkubGVuZ3RoO1xuXG4gICAgdGhpcy5lbGVtZW50U3RhY2sucHVzaChub2RlKTtcblxuICAgIGlmIChsID09PSAwKSB7IHJldHVybiB0aGlzLmVsZW1lbnRTdGFjay5wb3AoKTsgfVxuXG4gICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykge1xuICAgICAgdGhpcy5hY2NlcHROb2RlKHByb2dyYW0uYm9keVtpXSk7XG4gICAgfVxuXG4gICAgLy8gRW5zdXJlIHRoYXQgdGhhdCB0aGUgZWxlbWVudCBzdGFjayBpcyBiYWxhbmNlZCBwcm9wZXJseS5cbiAgICB2YXIgcG9wcGVkTm9kZSA9IHRoaXMuZWxlbWVudFN0YWNrLnBvcCgpO1xuICAgIGlmIChwb3BwZWROb2RlICE9PSBub2RlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmNsb3NlZCBlbGVtZW50IGBcIiArIHBvcHBlZE5vZGUudGFnICsgXCJgIChvbiBsaW5lIFwiICsgcG9wcGVkTm9kZS5sb2Muc3RhcnQubGluZSArIFwiKS5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5vZGU7XG4gIH0sXG5cbiAgQmxvY2tTdGF0ZW1lbnQ6IGZ1bmN0aW9uKGJsb2NrKSB7XG4gICAgZGVsZXRlIGJsb2NrLmludmVyc2VTdHJpcDtcbiAgICBkZWxldGUgYmxvY2sub3BlblN0cmluZztcbiAgICBkZWxldGUgYmxvY2suY2xvc2VTdHJpcDtcblxuICAgIGlmICh0aGlzLnRva2VuaXplci5zdGF0ZSA9PT0gJ2NvbW1lbnQnKSB7XG4gICAgICB0aGlzLmFwcGVuZFRvQ29tbWVudERhdGEoJ3t7JyArIHRoaXMuc291cmNlRm9yTXVzdGFjaGUoYmxvY2spICsgJ319Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudG9rZW5pemVyLnN0YXRlICE9PSAnY29tbWVudCcgJiYgdGhpcy50b2tlbml6ZXIuc3RhdGUgIT09ICdkYXRhJyAmJiB0aGlzLnRva2VuaXplci5zdGF0ZSAhPT0gJ2JlZm9yZURhdGEnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBIGJsb2NrIG1heSBvbmx5IGJlIHVzZWQgaW5zaWRlIGFuIEhUTUwgZWxlbWVudCBvciBhbm90aGVyIGJsb2NrLlwiKTtcbiAgICB9XG5cbiAgICBibG9jayA9IGFjY2VwdENvbW1vbk5vZGVzKHRoaXMsIGJsb2NrKTtcbiAgICB2YXIgcHJvZ3JhbSA9IGJsb2NrLnByb2dyYW0gPyB0aGlzLmFjY2VwdE5vZGUoYmxvY2sucHJvZ3JhbSkgOiBudWxsO1xuICAgIHZhciBpbnZlcnNlID0gYmxvY2suaW52ZXJzZSA/IHRoaXMuYWNjZXB0Tm9kZShibG9jay5pbnZlcnNlKSA6IG51bGw7XG5cbiAgICB2YXIgbm9kZSA9IGIuYmxvY2soYmxvY2sucGF0aCwgYmxvY2sucGFyYW1zLCBibG9jay5oYXNoLCBwcm9ncmFtLCBpbnZlcnNlLCBibG9jay5sb2MpO1xuICAgIHZhciBwYXJlbnRQcm9ncmFtID0gdGhpcy5jdXJyZW50RWxlbWVudCgpO1xuICAgIGFwcGVuZENoaWxkKHBhcmVudFByb2dyYW0sIG5vZGUpO1xuICB9LFxuXG4gIE11c3RhY2hlU3RhdGVtZW50OiBmdW5jdGlvbihyYXdNdXN0YWNoZSkge1xuICAgIGxldCB0b2tlbml6ZXIgPSB0aGlzLnRva2VuaXplcjtcbiAgICBsZXQgeyBwYXRoLCBwYXJhbXMsIGhhc2gsIGVzY2FwZWQsIGxvYyB9ID0gcmF3TXVzdGFjaGU7XG4gICAgbGV0IG11c3RhY2hlID0gYi5tdXN0YWNoZShwYXRoLCBwYXJhbXMsIGhhc2gsICFlc2NhcGVkLCBsb2MpO1xuXG4gICAgaWYgKHRva2VuaXplci5zdGF0ZSA9PT0gJ2NvbW1lbnQnKSB7XG4gICAgICB0aGlzLmFwcGVuZFRvQ29tbWVudERhdGEoJ3t7JyArIHRoaXMuc291cmNlRm9yTXVzdGFjaGUobXVzdGFjaGUpICsgJ319Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYWNjZXB0Q29tbW9uTm9kZXModGhpcywgbXVzdGFjaGUpO1xuXG4gICAgc3dpdGNoICh0b2tlbml6ZXIuc3RhdGUpIHtcbiAgICAgIC8vIFRhZyBoZWxwZXJzXG4gICAgICBjYXNlIFwidGFnTmFtZVwiOlxuICAgICAgICBhZGRFbGVtZW50TW9kaWZpZXIodGhpcy5jdXJyZW50Tm9kZSwgbXVzdGFjaGUpO1xuICAgICAgICB0b2tlbml6ZXIuc3RhdGUgPSBcImJlZm9yZUF0dHJpYnV0ZU5hbWVcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYmVmb3JlQXR0cmlidXRlTmFtZVwiOlxuICAgICAgICBhZGRFbGVtZW50TW9kaWZpZXIodGhpcy5jdXJyZW50Tm9kZSwgbXVzdGFjaGUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJhdHRyaWJ1dGVOYW1lXCI6XG4gICAgICBjYXNlIFwiYWZ0ZXJBdHRyaWJ1dGVOYW1lXCI6XG4gICAgICAgIHRoaXMuYmVnaW5BdHRyaWJ1dGVWYWx1ZShmYWxzZSk7XG4gICAgICAgIHRoaXMuZmluaXNoQXR0cmlidXRlVmFsdWUoKTtcbiAgICAgICAgYWRkRWxlbWVudE1vZGlmaWVyKHRoaXMuY3VycmVudE5vZGUsIG11c3RhY2hlKTtcbiAgICAgICAgdG9rZW5pemVyLnN0YXRlID0gXCJiZWZvcmVBdHRyaWJ1dGVOYW1lXCI7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImFmdGVyQXR0cmlidXRlVmFsdWVRdW90ZWRcIjpcbiAgICAgICAgYWRkRWxlbWVudE1vZGlmaWVyKHRoaXMuY3VycmVudE5vZGUsIG11c3RhY2hlKTtcbiAgICAgICAgdG9rZW5pemVyLnN0YXRlID0gXCJiZWZvcmVBdHRyaWJ1dGVOYW1lXCI7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBBdHRyaWJ1dGUgdmFsdWVzXG4gICAgICBjYXNlIFwiYmVmb3JlQXR0cmlidXRlVmFsdWVcIjpcbiAgICAgICAgYXBwZW5kRHluYW1pY0F0dHJpYnV0ZVZhbHVlUGFydCh0aGlzLmN1cnJlbnRBdHRyaWJ1dGUsIG11c3RhY2hlKTtcbiAgICAgICAgdG9rZW5pemVyLnN0YXRlID0gJ2F0dHJpYnV0ZVZhbHVlVW5xdW90ZWQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJhdHRyaWJ1dGVWYWx1ZURvdWJsZVF1b3RlZFwiOlxuICAgICAgY2FzZSBcImF0dHJpYnV0ZVZhbHVlU2luZ2xlUXVvdGVkXCI6XG4gICAgICBjYXNlIFwiYXR0cmlidXRlVmFsdWVVbnF1b3RlZFwiOlxuICAgICAgICBhcHBlbmREeW5hbWljQXR0cmlidXRlVmFsdWVQYXJ0KHRoaXMuY3VycmVudEF0dHJpYnV0ZSwgbXVzdGFjaGUpO1xuICAgICAgICBicmVhaztcblxuICAgICAgLy8gVE9ETzogT25seSBhcHBlbmQgY2hpbGQgd2hlbiB0aGUgdG9rZW5pemVyIHN0YXRlIG1ha2VzXG4gICAgICAvLyBzZW5zZSB0byBkbyBzbywgb3RoZXJ3aXNlIHRocm93IGFuIGVycm9yLlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYXBwZW5kQ2hpbGQodGhpcy5jdXJyZW50RWxlbWVudCgpLCBtdXN0YWNoZSk7XG4gICAgfVxuXG5cbiAgICByZXR1cm4gbXVzdGFjaGU7XG4gIH0sXG5cbiAgQ29udGVudFN0YXRlbWVudDogZnVuY3Rpb24oY29udGVudCkge1xuICAgIHZhciBjaGFuZ2VMaW5lcyA9IDA7XG4gICAgaWYgKGNvbnRlbnQucmlnaHRTdHJpcHBlZCkge1xuICAgICAgY2hhbmdlTGluZXMgPSBsZWFkaW5nTmV3bGluZURpZmZlcmVuY2UoY29udGVudC5vcmlnaW5hbCwgY29udGVudC52YWx1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy50b2tlbml6ZXIubGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmUgKyBjaGFuZ2VMaW5lcztcbiAgICB0aGlzLnRva2VuaXplci50b2tlbml6ZVBhcnQoY29udGVudC52YWx1ZSk7XG4gICAgdGhpcy50b2tlbml6ZXIuZmx1c2hEYXRhKCk7XG4gIH0sXG5cbiAgQ29tbWVudFN0YXRlbWVudDogZnVuY3Rpb24oY29tbWVudCkge1xuICAgIHJldHVybiBjb21tZW50O1xuICB9LFxuXG4gIFBhcnRpYWxTdGF0ZW1lbnQ6IGZ1bmN0aW9uKHBhcnRpYWwpIHtcbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHBhcnRpYWwpO1xuICAgIHJldHVybiBwYXJ0aWFsO1xuICB9LFxuXG4gIFN1YkV4cHJlc3Npb246IGZ1bmN0aW9uKHNleHByKSB7XG4gICAgcmV0dXJuIGFjY2VwdENvbW1vbk5vZGVzKHRoaXMsIHNleHByKTtcbiAgfSxcblxuICBQYXRoRXhwcmVzc2lvbjogZnVuY3Rpb24ocGF0aCkge1xuICAgIGRlbGV0ZSBwYXRoLmRhdGE7XG4gICAgZGVsZXRlIHBhdGguZGVwdGg7XG5cbiAgICByZXR1cm4gcGF0aDtcbiAgfSxcblxuICBIYXNoOiBmdW5jdGlvbihoYXNoKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXNoLnBhaXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmFjY2VwdE5vZGUoaGFzaC5wYWlyc1tpXS52YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhc2g7XG4gIH0sXG5cbiAgU3RyaW5nTGl0ZXJhbDogZnVuY3Rpb24oKSB7fSxcbiAgQm9vbGVhbkxpdGVyYWw6IGZ1bmN0aW9uKCkge30sXG4gIE51bWJlckxpdGVyYWw6IGZ1bmN0aW9uKCkge30sXG4gIFVuZGVmaW5lZExpdGVyYWw6IGZ1bmN0aW9uKCkge30sXG4gIE51bGxMaXRlcmFsOiBmdW5jdGlvbigpIHt9XG59O1xuXG5mdW5jdGlvbiBsZWFkaW5nTmV3bGluZURpZmZlcmVuY2Uob3JpZ2luYWwsIHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gJycpIHtcbiAgICAvLyBpZiBpdCBpcyBlbXB0eSwganVzdCByZXR1cm4gdGhlIGNvdW50IG9mIG5ld2xpbmVzXG4gICAgLy8gaW4gb3JpZ2luYWxcbiAgICByZXR1cm4gb3JpZ2luYWwuc3BsaXQoXCJcXG5cIikubGVuZ3RoIC0gMTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgcmV0dXJuIHRoZSBudW1iZXIgb2YgbmV3bGluZXMgcHJpb3IgdG9cbiAgLy8gYHZhbHVlYFxuICB2YXIgZGlmZmVyZW5jZSA9IG9yaWdpbmFsLnNwbGl0KHZhbHVlKVswXTtcbiAgdmFyIGxpbmVzID0gZGlmZmVyZW5jZS5zcGxpdCgvXFxuLyk7XG5cbiAgcmV0dXJuIGxpbmVzLmxlbmd0aCAtIDE7XG59XG5cbmZ1bmN0aW9uIGFjY2VwdENvbW1vbk5vZGVzKGNvbXBpbGVyLCBub2RlKSB7XG4gIGNvbXBpbGVyLmFjY2VwdE5vZGUobm9kZS5wYXRoKTtcblxuICBpZiAobm9kZS5wYXJhbXMpIHtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUucGFyYW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb21waWxlci5hY2NlcHROb2RlKG5vZGUucGFyYW1zW2ldKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbm9kZS5wYXJhbXMgPSBbXTtcbiAgfVxuXG4gIGlmIChub2RlLmhhc2gpIHtcbiAgICBjb21waWxlci5hY2NlcHROb2RlKG5vZGUuaGFzaCk7XG4gIH0gZWxzZSB7XG4gICAgbm9kZS5oYXNoID0gYi5oYXNoKCk7XG4gIH1cblxuICByZXR1cm4gbm9kZTtcbn1cblxuZnVuY3Rpb24gYWRkRWxlbWVudE1vZGlmaWVyKGVsZW1lbnQsIG11c3RhY2hlKSB7XG4gIGxldCB7IHBhdGgsIHBhcmFtcywgaGFzaCwgbG9jIH0gPSBtdXN0YWNoZTtcbiAgbGV0IG1vZGlmaWVyID0gYi5lbGVtZW50TW9kaWZpZXIocGF0aCwgcGFyYW1zLCBoYXNoLCBsb2MpO1xuICBlbGVtZW50Lm1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTtcbn1cblxuZnVuY3Rpb24gYXBwZW5kRHluYW1pY0F0dHJpYnV0ZVZhbHVlUGFydChhdHRyaWJ1dGUsIHBhcnQpIHtcbiAgYXR0cmlidXRlLmlzRHluYW1pYyA9IHRydWU7XG4gIGF0dHJpYnV0ZS5wYXJ0cy5wdXNoKHBhcnQpO1xufVxuIl19